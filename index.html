<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Vegan Recipes</title>

    <!-- SEO & Social Meta Tags -->
    <meta id="metaDesc" name="description" content="Find fresh daily vegan recipes from top bloggers. Search by ingredients, diet types, or explore new plant-based dishes.">
    
    <link id="canonicalLink" rel="canonical" href="https://findvegdish.com/">
    <meta name="robots" content="index, follow, max-image-preview:large">

    <!-- PERFORMANCE: Preload Critical Data Source -->
    <link rel="preload" href="data.json" as="fetch" crossorigin>

    <!-- 1. STATIC SCHEMA MIGRATION: WebSite & SearchAction (Hardcoded for immediate availability) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "url": "https://findvegdish.com/",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://findvegdish.com/?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>

    <!-- Open Graph Tags (Dynamic via JS) -->
    <meta property="og:title" content="Daily Vegan Recipes">
    <meta property="og:description" content="Daily recipes from the top bloggers">
    <meta property="og:image" content="https://findvegdish.com/default.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://findvegdish.com">
    <meta property="og:type" content="website">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">

    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
            padding-bottom: 60px;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .logo-link {
            display: inline-block;
            cursor: pointer;
            text-decoration: none;
            border: none;
            background: none;
        }

        .logo-img {
            max-width: 90%;
            width: 350px;
            height: auto;
            display: block;
            margin: 0 auto 3px auto;
            transition: transform 0.2s;
        }
        
        .logo-link:active .logo-img {
            transform: scale(0.98); 
        }
        
        .sub-intro {
            text-align: center;
            font-size: 0.9em;
            font-weight: 400;
            color: #888; 
            margin: -5px 0 15px 0; 
            line-height: 1.5;
        }

        /* --- SEARCH ROW STYLES --- */
        .search-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 480px;
            margin: 10px auto;
        }

        .search-wrapper {
            position: relative;
            flex-grow: 1;
        }

        #searchInput {
            padding: 12px 45px 12px 20px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 25px;
            border: 1px solid #ddd;
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            outline: none;
            transition: all 0.3s ease;
            color: #769F37; 
            font-weight: 600;
        }
        
        #searchInput:hover {
            border-color: #769F37;
        }

        #searchInput:focus {
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-color: #769F37;
        }
        #searchInput::placeholder {
            color: #aaa;
            font-weight: 400;
        }

        #clearBtn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            color: #aaa;
            cursor: pointer;
            display: none;
            padding: 5px;
        }
        #clearBtn:hover { color: #555; }

        /* --- SHUFFLE BUTTON --- */
        #shuffleIconBtn {
            width: 48px;
            height: 48px;
            border-radius: 50%; 
            background-color: white; 
            border: 1px solid #ddd; /* Matches chip filter depth */
            color: #769F37; 
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #shuffleIconBtn:active {
            transform: scale(0.95);
        }
        @media (hover: hover) {
            #shuffleIconBtn:hover {
                background-color: #769F37;
                border-color: #769F37; /* Restore green border on hover */
                color: white;
                box-shadow: 0 4px 8px rgba(118, 159, 55, 0.3);
            }
        }

        @keyframes jiggle {
            0%, 100% { transform: rotate(0deg); }
            15% { transform: rotate(-8deg); }
            30% { transform: rotate(8deg); }
            45% { transform: rotate(-6deg); }
            60% { transform: rotate(6deg); }
            75% { transform: rotate(-3deg); }
            90% { transform: rotate(3deg); }
        }
        .jiggle {
            animation: jiggle 1s ease-in-out;
        }

        /* --- SCROLLING CONTROLS --- */
        .controls {
            display: flex;
            align-items: center;
            gap: 10px; 
            margin-top: 15px;
            width: 100%;
            flex-wrap: nowrap; 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 5px; 
            scrollbar-width: none; 
            justify-content: flex-start;
            padding-left: 5px; 
            padding-right: 5px;
        }
        
        .controls::-webkit-scrollbar { display: none; }

        @media (min-width: 550px) {
            .controls {
                justify-content: center;
            }
        }
        
        @media (max-width: 549px) {
            .controls::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to right, rgba(248, 249, 250, 0), rgba(248, 249, 250, 1) 80%);
                pointer-events: none; 
            }
        }

        .btn {
            padding: 10px 18px; 
            border-radius: 25px;
            border: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.1s, background 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #555;
            background-color: white;
            border: 1px solid #ddd;
            -webkit-tap-highlight-color: transparent; 
            white-space: nowrap; 
            flex-shrink: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-decoration: none; 
        }
        @media (hover: hover) {
               .btn:hover { background-color: #f0f0f0; }
        }
        .btn:active { 
            transform: scale(0.95); 
            background-color: #e0e0e0;
        }

        .btn.active-filter {
            background-color: #769F37 !important; 
            color: white !important;
            border-color: #769F37 !important;
        }

        /* Install button CSS removed here */

        .gallery {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            margin-top: 25px;
            grid-auto-flow: row; 
            min-height: 500px; 
        }
        
        @media (max-width: 1100px) { .gallery { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 800px) { .gallery { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 500px) { .gallery { grid-template-columns: 1fr; } }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            overflow: hidden;
            display: flex;
            flex-direction: column; 
            position: relative;
            animation: fadeIn 0.5s ease-in;
            height: 100%;
            /* 3. CSS content-visibility: Performance boost for rendering large lists */
            content-visibility: auto;
            contain-intrinsic-size: 400px; 
        }
        
        .card-link {
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        
        .card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }
        
        .share-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s, background 0.2s;
            border: none;
            outline: none;
            padding: 0;
        }
        .share-btn:hover { transform: scale(1.1); background-color: #f0f0f0; }
        .share-btn svg { width: 22px; height: 22px; fill: #555; }

        .info { 
            padding: 15px; 
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            align-items: flex-start; 
        }
        
        .meta-row {
            display: flex;
            align-items: center;
            gap: 8px; 
            margin-bottom: 5px;
            width: 100%;
            flex-wrap: wrap; 
        }
        
        .tag {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #769F37; 
            font-weight: 600;
            display: inline-block;
        }
        .disruptor-tag { color: #e67e22; }
        
        .fresh-badge, .wfpb-badge, .easy-badge, .budget-badge, .gf-badge {
            color: white;
            font-size: 0.7em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        .fresh-badge {
            background-color: #769F37; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; }
        }

        .wfpb-badge { background-color: #16a085; }
        .easy-badge { background-color: #2980b9; }
        .budget-badge { background-color: #8e44ad; }
        .gf-badge { background-color: #f39c12; }

        .title {
            font-size: 1.1em;
            font-weight: 600;
            line-height: 1.4;
            margin: 5px 0;
            color: #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        h2.title { margin: 5px 0; }
        
        .blogger { font-size: 0.9em; color: #888; margin-top: auto; padding-top: 10px; }
        
        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 1.2em;
            color: #888;
            margin-top: 40px;
        }

        /* --- SKELETON LOADING STYLES --- */
        .skeleton-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 400px;
        }
        .skeleton-img {
            width: 100%;
            height: 250px;
            background-color: #eee;
            animation: skeleton-pulse 1.5s infinite ease-in-out;
        }
        .skeleton-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .skeleton-text {
            height: 20px;
            background-color: #eee;
            border-radius: 4px;
            animation: skeleton-pulse 1.5s infinite ease-in-out;
        }
        .w-60 { width: 60%; }
        .w-80 { width: 80%; }
        .w-40 { width: 40%; }
        
        @keyframes skeleton-pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        footer { text-align: center; margin-top: 50px; color: #aaa; font-size: 0.9em; padding: 0 20px;}
        
        .footer-topics {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        .footer-topics a {
            color: #888;
            text-decoration: none;
            font-size: 0.85em;
        }
        .footer-topics a:hover {
            color: #769F37;
            text-decoration: underline;
        }

        #loader { text-align: center; padding: 20px; color: #888; font-style: italic; display: none; }

        #scrollTopBtn {
            display: none; 
            position: fixed;
            bottom: 95px;
            right: 18px;
            z-index: 99;
            width: 60px;
            height: 60px;
            border: none;
            outline: none;
            background-color: #769F37;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: background-color 0.3s, transform 0.3s;
            align-items: center;
            justify-content: center;
        }
        #scrollTopBtn:hover {
            background-color: #5d822b; 
            transform: translateY(-3px);
        }
        @media (max-width: 400px) {
            #scrollTopBtn { bottom: 90px; right: 18px; width: 50px; height: 50px; }
        }
    </style>
</head>
<body>

<header>
    <h1 class="sr-only">Daily Vegan Recipes</h1>

    <a href="index.html" class="logo-link" title="Refresh">
        <!-- 4. IMAGE OPTIMIZATION: FetchPriority High & Async Decoding for LCP -->
        <img src="default.jpg" alt="Daily Vegan Recipes" class="logo-img" fetchpriority="high" decoding="async">
    </a>
    
    <p class="sub-intro">Discover the newest recipes from over 80 creators</p>
    
    <div class="search-row">
        <button id="shuffleIconBtn" onclick="shuffleRecipes()" title="Shuffle Recipes">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <!-- Arrowheads (Placed at the end of the lines) -->
  <polyline points="17 4 21 7 17 10" />
  <polyline points="17 14 21 17 17 20" />
  
  <!-- Top-Left to Bottom-Right Path (Stops at x=17) -->
  <path d="M3 7h3c2.5 0 4.5 10 7.5 10h3.5" />
  
  <!-- Bottom-Left to Top-Right Path (Stops at x=17) -->
  <path d="M3 17h3c2.5 0 4.5-10 7.5-10h3.5" />
</svg>
        </button>
        
        <div class="search-wrapper">
            <label for="searchInput" style="display:none;">Search Recipes</label>
            <!-- 5. INPUT UX: Input Mode and Enter Key Hint -->
            <input type="text" id="searchInput" placeholder="Search: Soup, Blog, Cake..." inputmode="search" enterkeyhint="search">
            <button id="clearBtn" title="Clear Search">‚úï</button>
        </div>
    </div>

    <div class="controls">
        <a href="?type=meal" class="btn" id="mealsBtn" onclick="toggleType(event, 'meal')">üçù Meals</a>
        <a href="?type=sweet" class="btn" id="sweetsBtn" onclick="toggleType(event, 'sweet')">üç™ Sweets</a>
        <a href="?tag=Budget" class="btn" id="budgetBtn" onclick="toggleTag(event, 'Budget')">üí∏ Budget</a>
        <a href="?tag=Easy" class="btn" id="easyBtn" onclick="toggleTag(event, 'Easy')">‚ö° Easy</a>
        <a href="?tag=Protein" class="btn" id="proteinBtn" onclick="toggleTag(event, 'Protein')">‚¨ÜÔ∏è Protein</a>
        <a href="?tag=WFPB" class="btn" id="wfpbBtn" onclick="toggleTag(event, 'WFPB')">ü•ó WFPB</a>
        <a href="?tag=GF" class="btn" id="gfBtn" onclick="toggleTag(event, 'GF')">üåæ GF</a>        
    </div>
</header>

<!-- 7. SEMANTIC OUTLINE: aria-busy indicates loading state -->
<main id="gallery" class="gallery" aria-busy="true" aria-label="Recipe Gallery">
    <!-- SEO & PERFORMANCE: Skeleton Screens for Layout Stability & Initial Crawl -->
    <noscript>
        <div style="grid-column: 1 / -1; text-align: center; padding: 20px;">
            <h3>Explore Categories:</h3>
            <p>
                <a href="?type=meal">Vegan Meals</a> | 
                <a href="?type=sweet">Vegan Sweets</a> | 
                <a href="?tag=Budget">Budget Recipes</a> | 
                <a href="?tag=Easy">Easy Recipes</a>
            </p>
        </div>
    </noscript>
    
    <!-- 7. SEMANTIC OUTLINE: Skeletons as hidden articles -->
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
</main>
<div id="loader">Loading more recipes...</div>

<button id="scrollTopBtn" title="Go to top" aria-label="Scroll to top">
    <svg viewBox="0 0 24 24" width="30" height="30" fill="white">
        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
    </svg>
</button>

<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="natethevegan" data-description="Support me on Buy me a coffee!" data-message="" data-color="#769F37" data-position="Right" data-x_margin="18" data-y_margin="18"></script>

<footer>
    <p>Daily Vegan Recipes aggregates the best plant-based cooking from top bloggers. Discover easy vegan dinner ideas, high-protein plant-based meals, WFPB (Whole Food Plant Based) dishes, gluten-free sweets, and budget-friendly vegan food. Updated daily.</p>
    
    <div class="footer-topics">
        <a href="?q=pasta">Best Vegan Pasta</a>
        <a href="?q=tofu">Tofu Recipes</a>
        <a href="?q=soup">Vegan Soups</a>
        <a href="?q=salad">Healthy Salads</a>
        <a href="?q=curry">Plant-Based Curry</a>
        <a href="?q=breakfast">Vegan Breakfast</a>
        <a href="?q=protein">High Protein Vegan</a>
        <a href="?q=wfpb">Whole Food Plant Based</a>
        <a href="?q=gluten+free">Gluten Free Vegan</a>
        <a href="?q=budget">Budget Friendly</a>
        <a href="?q=dessert">Vegan Desserts</a>
    </div>
</footer>

<script>
    // --- GLOBAL STATE ---
    let allRecipes = [];          
    let currentContext = [];      
    let renderedCount = 0;        
    
    // Filtering State
    let activeType = null; 
    let activeTags = new Set(); 
    
    const BATCH_SIZE = 48;        

    // --- CONFIGURATION ---
    // Maps internal database names to user-friendly display names
    const BLOG_DISPLAY_MAP = {
        "Rainbow Plant Life GF": "Rainbow Plant Life",
        "Vegan Richa GF": "Vegan Richa"
    };

    // --- KEYWORDS ---
    const SWEET_KEYWORDS = ['cookie', 'cake', 'brownie', 'chocolate', 'dessert', 'pie', 'tart', 'muffin', 'donut', 'doughnut', 'ice cream', 'pudding', 'cheesecake', 'sweet', 'fudge', 'truffle', 'bar', 'cupcake', 'blondie', 'galette', 'cobbler', 'mousse', 'cinnamon roll', 'scone', 'waffle', 'pancake'];
    const MEAL_KEYWORDS = ['pasta', 'burger', 'curry', 'soup', 'stew', 'taco', 'pizza', 'sandwich', 'wrap', 'salad', 'bowl', 'rice', 'noodle', 'stir fry', 'lasagna', 'casserole', 'tofu', 'tempeh', 'lentil', 'chickpea', 'potato', 'dinner', 'lunch', 'roast', 'chili', 'shepherd', 'risotto', 'gnocchi', 'quiche', 'enchilada', 'burrito', 'quesadilla', 'mac and cheese', 'dumpling', 'meatball', 'loaf', 'skillet', 'gratin', 'pad thai', 'ramen'];
    const PROTEIN_KEYWORDS = ['tofu', 'tempeh', 'seitan', 'tvp', 'lentil', 'bean', 'chickpea', 'edamame', 'soy', 'quinoa', 'peanut', 'meatball', 'burger', 'sausage', 'protein', 'falafel', 'hummus', 'nut roast'];

    // --- UTILS ---
    // --- UTILS ---
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // Standard Levenshtein Distance Algorithm
    function levenshteinDistance(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;
        const matrix = [];
        for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
        for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1, 
                        Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1) 
                    );
                }
            }
        }
        return matrix[b.length][a.length];
    }

    // "Tight" Fuzzy Match Logic
    function isFuzzyMatch(query, text) {
        // 1. Fast path: Exact substring match
        if (text.includes(query)) return true;

        // 2. Tokenize: Split user query and target text into words
        const queryTokens = query.split(/\s+/).filter(t => t.length > 0);
        const textTokens = text.split(/\s+/).filter(t => t.length > 0);

        // 3. Logic: Every word in the user's query must "match" a word in the text
        return queryTokens.every(qToken => {
            return textTokens.some(tToken => {
                // Optimization: Skip if length difference is too large
                if (Math.abs(qToken.length - tToken.length) > 2) return false;

                const dist = levenshteinDistance(qToken, tToken);
                
                // TIGHT THRESHOLDS:
                // Word length < 4: Must be exact (e.g., "pie" vs "die")
                // Word length 4-7: Allow 1 typo (e.g., "aple" vs "apple")
                // Word length > 7: Allow 2 typos (e.g., "brocolli" vs "broccoli")
                if (qToken.length < 4) return dist === 0;
                if (qToken.length <= 7) return dist <= 1;
                return dist <= 2;
            });
        });
    }

    // --- INITIALIZATION ---
    // Visitor tracking for Shuffle Animation
    try {
        const visitKey = 'shuffle_visit_data';
        const now = Date.now();
        const oneHour = 60 * 60 * 1000;
        let visitData = JSON.parse(localStorage.getItem(visitKey) || '{"count": 0, "lastVisit": 0}');
        
        // Reset if more than 1 hour has passed
        if (now - visitData.lastVisit > oneHour) {
            visitData.count = 1; // Start new session
        } else {
            visitData.count++; // Increment within session
        }
        visitData.lastVisit = now;
        localStorage.setItem(visitKey, JSON.stringify(visitData));

        if (visitData.count > 1) {
            const btn = document.getElementById('shuffleIconBtn');
            if (btn) btn.classList.add('jiggle');
        }
    } catch (e) { console.error('Storage access restricted', e); }

    fetch('data.json?v=' + new Date().getTime())
        .then(response => response.json())
        .then(data => {
            allRecipes = data;
            currentContext = allRecipes; 
            
            // 1. Static Schema Migration: Function removed. Schema is now in <head>.
            
            setupInfiniteScroll();   
            parseURLState();
        })
        .catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('gallery').innerHTML = '<p style="text-align:center">Could not load recipes.</p>';
            // Remove busy state if error
            document.getElementById('gallery').setAttribute('aria-busy', 'false');
        });

    window.addEventListener('popstate', () => {
        parseURLState();
    });

    // --- URL & SEO LOGIC ---

    function parseURLState() {
        const params = new URLSearchParams(window.location.search);
        
        activeType = null;
        activeTags.clear();
        document.getElementById('mealsBtn').classList.remove('active-filter');
        document.getElementById('sweetsBtn').classList.remove('active-filter');
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active-filter'));
        document.getElementById('searchInput').value = '';

        if (params.has('q')) {
            document.getElementById('searchInput').value = params.get('q');
            document.getElementById('clearBtn').style.display = 'block';
        }

        if (params.has('type')) {
            const type = params.get('type');
            activeType = type;
            if (type === 'meal') document.getElementById('mealsBtn').classList.add('active-filter');
            if (type === 'sweet') document.getElementById('sweetsBtn').classList.add('active-filter');
        }

        if (params.has('tag')) {
            const tags = params.get('tag').split(',');
            tags.forEach(t => {
                activeTags.add(t);
                const btn = document.getElementById(t.toLowerCase() + 'Btn');
                if (btn) btn.classList.add('active-filter');
            });
        }

        applyFilters(false); 
    }

    function updateURL() {
        const params = new URLSearchParams();
        const searchVal = document.getElementById('searchInput').value;
        
        if (searchVal) params.set('q', searchVal);
        if (activeType) params.set('type', activeType);
        if (activeTags.size > 0) params.set('tag', Array.from(activeTags).join(','));

        const newURL = params.toString() ? `?${params.toString()}` : window.location.pathname;
        history.pushState({}, '', newURL);
        
        const canonical = document.getElementById('canonicalLink');
        if (canonical) canonical.href = "https://findvegdish.com/" + newURL;
    }

    // 2. DYNAMIC NOINDEX: Helps prevent Soft 404s on empty search results
    function updateNoIndexState(isZeroResults) {
        let meta = document.querySelector('meta[name="robots"]');
        if (isZeroResults) {
            if (!meta) {
                meta = document.createElement('meta');
                meta.name = 'robots';
                document.head.appendChild(meta);
            }
            meta.content = "noindex, follow";
        } else {
            // Restore default if it exists or reset
            if (meta) meta.content = "index, follow, max-image-preview:large";
        }
    }

    function updateSEO(currentRecipes = []) {
        let title = "Daily Vegan Recipes";
        let desc = "Find fresh daily vegan recipes from top bloggers. Search by ingredients, diet types, or explore new plant-based dishes. ";
        let breadcrumbName = "Home";
        
        const searchVal = document.getElementById('searchInput').value;
        const tagsArr = Array.from(activeTags);

        if (searchVal) {
            title = `${searchVal} - Search | Daily Vegan Recipes`;
            desc = `Best vegan recipes matching "${searchVal}".`;
            breadcrumbName = `Search: ${searchVal}`;
        } else if (activeType === 'meal') {
            title = "Vegan Dinner & Meal Ideas | Daily Vegan Recipes";
            desc = "Discover savory vegan meals, dinners, and lunch ideas from top plant-based blogs.";
            breadcrumbName = "Meals";
        } else if (activeType === 'sweet') {
            title = "Vegan Sweets & Desserts | Daily Vegan Recipes";
            desc = "Indulge in the best vegan desserts, cookies, cakes, and sweets.";
            breadcrumbName = "Sweets";
        } else if (tagsArr.length > 0) {
            const primaryTag = tagsArr[0];
            title = `${primaryTag} Vegan Recipes | Daily Vegan Recipes`;
            desc = `Top rated ${primaryTag} vegan recipes updated daily.`;
            breadcrumbName = primaryTag;
        }

        document.title = title;
        const metaDesc = document.getElementById('metaDesc');
        if (metaDesc) metaDesc.content = desc;

        const ogTitle = document.querySelector('meta[property="og:title"]');
        const ogDesc = document.querySelector('meta[property="og:description"]');
        const ogUrl = document.querySelector('meta[property="og:url"]');
        
        if (ogTitle) ogTitle.content = title;
        if (ogDesc) ogDesc.content = desc;
        if (ogUrl) ogUrl.content = window.location.href;

        updateBreadcrumbSchema(breadcrumbName);
        updateItemListSchema(currentRecipes);
        
        // Trigger NoIndex check based on result count
        updateNoIndexState(currentRecipes.length === 0);
    }

    function updateBreadcrumbSchema(currentItemName) {
        const oldScript = document.getElementById('dynamic-schema');
        if (oldScript) oldScript.remove();

        if (currentItemName === "Home") return;

        const schema = {
            "@context": "https://schema.org",
            "@type": "BreadcrumbList",
            "itemListElement": [{
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": "https://findvegdish.com/"
            }, {
                "@type": "ListItem",
                "position": 2,
                "name": currentItemName,
                "item": window.location.href
            }]
        };

        const script = document.createElement('script');
        script.id = 'dynamic-schema';
        script.type = 'application/ld+json';
        script.text = JSON.stringify(schema);
        document.head.appendChild(script);
    }

    function updateItemListSchema(recipes) {
        const oldScript = document.getElementById('item-list-schema');
        if (oldScript) oldScript.remove();

        if (!recipes || recipes.length === 0) return;

        const topRecipes = recipes.slice(0, 20);

        const schema = {
            "@context": "https://schema.org",
            "@type": "ItemList",
            "itemListElement": topRecipes.map((recipe, index) => ({
                "@type": "ListItem",
                "position": index + 1,
                "url": recipe.link,
                "name": recipe.title,
                "image": recipe.image
            }))
        };

        const script = document.createElement('script');
        script.id = 'item-list-schema';
        script.type = 'application/ld+json';
        script.text = JSON.stringify(schema);
        document.head.appendChild(script);
    }

    // --- RENDER LOGIC ---
    function renderNextBatch() {
        const gallery = document.getElementById('gallery');
        const loader = document.getElementById('loader');
        
        // 7. SEMANTIC OUTLINE: Remove busy state once we start rendering real content
        gallery.setAttribute('aria-busy', 'false');

        if (currentContext.length === 0) {
            gallery.innerHTML = '<div class="no-results">No recipes found. Try a different combination!</div>';
            loader.style.display = 'none';
            return;
        }

        if (renderedCount >= currentContext.length) {
            loader.style.display = 'none';
            return;
        }

        const nextBatch = currentContext.slice(renderedCount, renderedCount + BATCH_SIZE);
        
        nextBatch.forEach((recipe, index) => {
            const isLcpCandidate = (renderedCount === 0 && index < 4);
            const card = createCard(recipe, isLcpCandidate);
            gallery.appendChild(card);
        });

        renderedCount += nextBatch.length;
        
        if (renderedCount < currentContext.length) {
            loader.style.display = 'block';
        } else {
            loader.style.display = 'none';
        }
    }

    function createCard(recipe, isLcp = false) {
        const card = document.createElement('article');
        card.className = 'card';

        const link = document.createElement('a');
        link.className = 'card-link';
        link.href = recipe.link;
        link.target = "_blank"; 
        link.rel = "noopener noreferrer";

        const img = document.createElement('img');
        img.src = recipe.image;
        img.width = 400;
        img.height = 250; 
        img.alt = `${recipe.title} - Vegan Recipe by ${recipe.blog_name}`;
        
        // 4. IMAGE OPTIMIZATION: Async decoding for list items
        img.decoding = "async";

        if (isLcp) {
            img.loading = "eager";
            img.setAttribute("fetchpriority", "high");
        } else {
            img.loading = "lazy"; 
        }
        
        img.referrerPolicy = "no-referrer";
        img.onerror = function() { 
            this.onerror = null; 
            this.src = 'icon.jpg'; 
        };

        const info = document.createElement('div');
        info.className = 'info';

        let tagClass = 'tag';
        let tagText = 'Top Blog';
        if(recipe.is_disruptor) {
            tagClass += ' disruptor-tag';
            tagText = 'Rising Blog';
        }

        const recipeDate = new Date(recipe.date);
        const now = new Date();
        const hoursOld = (now - recipeDate) / (1000 * 3600);
        
        let badgeHTML = '';
        if (hoursOld < 20) {
            badgeHTML += '<span class="fresh-badge">New Today</span>';
        }

        if (recipe.special_tags && Array.isArray(recipe.special_tags)) {
            recipe.special_tags.forEach(tag => {
                if (tag === 'WFPB') {
                    badgeHTML += '<span class="wfpb-badge">WFPB</span>';
                } else if (tag === 'Easy') {
                    badgeHTML += '<span class="easy-badge">Easy</span>';
                } else if (tag === 'Budget') {
                    badgeHTML += '<span class="budget-badge">Budget</span>';
                } else if (tag === 'GF') {
                    badgeHTML += '<span class="gf-badge">GF</span>';
                }
            });
        }
        
        // --- DISPLAY NAME LOGIC ---
        // If the blog name is "Rainbow Plant Life GF", display "Rainbow Plant Life"
        const displayBlogger = BLOG_DISPLAY_MAP[recipe.blog_name] || recipe.blog_name;

        info.innerHTML = `
            <div class="meta-row">
                <span class="${tagClass}">${tagText}</span>
                ${badgeHTML}
            </div>
            <h2 class="title" title="${recipe.title}">${recipe.title}</h2>
            <div class="blogger">by ${displayBlogger}</div>
        `;

        const shareBtn = document.createElement('button');
        shareBtn.className = 'share-btn';
        shareBtn.ariaLabel = "Share Recipe";
        shareBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>`;
        shareBtn.onclick = (e) => shareRecipe(e, recipe.title, recipe.link);

        link.appendChild(img);
        link.appendChild(info);
        card.appendChild(shareBtn);
        card.appendChild(link);
        
        return card;
    }

    function setupInfiniteScroll() {
        window.addEventListener('scroll', () => {
            const scrollBtn = document.getElementById("scrollTopBtn");
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                scrollBtn.style.display = "flex";
            } else {
                scrollBtn.style.display = "none";
            }
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                if (renderedCount < currentContext.length) {
                    renderNextBatch();
                }
            }
        });
        document.getElementById("scrollTopBtn").addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    function resetView(newContext) {
        currentContext = newContext;
        renderedCount = 0;
        // Clears the Skeleton Loaders or previous results
        document.getElementById('gallery').innerHTML = '';
        renderNextBatch();
    }

    function shuffleRecipes() {
        // Trigger Jiggle Animation
        const btn = document.getElementById('shuffleIconBtn');
        if (btn) {
            btn.classList.remove('jiggle');
            void btn.offsetWidth; // Trigger reflow to restart animation
            btn.classList.add('jiggle');
        }

        document.activeElement.blur(); 
        for (let i = allRecipes.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allRecipes[i], allRecipes[j]] = [allRecipes[j], allRecipes[i]];
        }
        applyFilters(true);
    }

    function toggleType(e, type) {
        if(e) e.preventDefault(); 
        document.activeElement.blur();
        const mealsBtn = document.getElementById('mealsBtn');
        const sweetsBtn = document.getElementById('sweetsBtn');

        if (activeType === type) {
            activeType = null;
            mealsBtn.classList.remove('active-filter');
            sweetsBtn.classList.remove('active-filter');
        } else {
            activeType = type;
            if (type === 'meal') {
                mealsBtn.classList.add('active-filter');
                sweetsBtn.classList.remove('active-filter');
            } else {
                sweetsBtn.classList.add('active-filter');
                mealsBtn.classList.remove('active-filter');
            }
        }
        applyFilters(true);
    }

    function toggleTag(e, tagName) {
        if(e) e.preventDefault(); 
        document.activeElement.blur();
        const btnId = tagName.toLowerCase() + 'Btn';
        const btn = document.getElementById(btnId);

        if (activeTags.has(tagName)) {
            activeTags.delete(tagName);
            btn.classList.remove('active-filter');
        } else {
            activeTags.add(tagName);
            btn.classList.add('active-filter');
        }
        applyFilters(true);
    }

    function applyFilters(pushState = true) {
        const rawInput = document.getElementById('searchInput').value;
        const term = rawInput.toLowerCase().replace(/-/g, ' '); 
        
        const SAVORY_EXCEPTIONS = ['sweet potato', 'sweet and sour', 'sweet corn', 'sweet pea', 'sweet chili', 'sweet pepper'];
        const SWEET_EXCEPTIONS = ['rice', 'instant pot', 'crock pot', 'one pot', 'cup', 'butter', 'nut']; 

        let filtered = allRecipes;

        if (term.length > 0) {
            filtered = filtered.filter(recipe => {
                // Special case for the "Protein" button/keyword
                if (term === 'protein') {
                    const t = recipe.title.toLowerCase();
                    return PROTEIN_KEYWORDS.some(k => t.includes(k));
                }

                // Prepare Data for Search
                const title = recipe.title.toLowerCase().replace(/-/g, ' ');
                const blogger = recipe.blog_name.toLowerCase().replace(/-/g, ' ');
                const tags = (recipe.special_tags || []).join(' ').toLowerCase().replace(/-/g, ' ');
                
                // Combine all searchable text into one string for efficient token matching
                const searchableText = `${title} ${blogger} ${tags}`;
                
                // Run the "Tight" Fuzzy Match
                return isFuzzyMatch(term, searchableText);
            });
        }

        if (activeType === 'meal') {
            filtered = filtered.filter(recipe => {
                const t = recipe.title.toLowerCase();
                const hasMealKeyword = MEAL_KEYWORDS.some(k => t.includes(k));
                const hasSweetKeyword = SWEET_KEYWORDS.some(k => t.includes(k));
                const isSavoryException = SAVORY_EXCEPTIONS.some(k => t.includes(k));
                const isSide = t.includes('sauce') || t.includes('dressing') || t.includes('side') || t.includes('treats');
                return hasMealKeyword && (!hasSweetKeyword || isSavoryException) && !isSide;
            });
        } else if (activeType === 'sweet') {
            filtered = filtered.filter(recipe => {
                const t = recipe.title.toLowerCase();
                const hasSweetKeyword = SWEET_KEYWORDS.some(k => t.includes(k));
                const hasMealKeyword = MEAL_KEYWORDS.some(k => t.includes(k));
                const isSweetException = SWEET_EXCEPTIONS.some(k => t.includes(k));
                const isSavory = t.includes('spicy') || t.includes('chili') || t.includes("shepherd's") || t.includes('egg') || t.includes('burger');
                const isExplicitlySavory = SAVORY_EXCEPTIONS.some(k => t.includes(k));
                return hasSweetKeyword && (!hasMealKeyword || isSweetException) && !isExplicitlySavory && !isSavory;
            });
        }

       if (activeTags.size > 0) {
            filtered = filtered.filter(recipe => {
                const title = recipe.title.toLowerCase();
                
                for (let tag of activeTags) {
                    if (tag === 'Protein') {
                        // Protein is still calculated via keywords in JS
                        if (!PROTEIN_KEYWORDS.some(k => title.includes(k))) return false;
                    } 
                    else {
                        // WFPB, Easy, Budget, and GF are now all in special_tags from Python
                        if (!recipe.special_tags || !recipe.special_tags.includes(tag)) return false;
                    }
                }
                return true;
            });
        }

        if (pushState) {
            updateURL();
        }
        
        updateSEO(filtered);
        resetView(filtered);
    }

    const processSearchChange = debounce(() => {
        applyFilters(true);
    }, 300);

    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');

    searchInput.addEventListener('keyup', (e) => {
        clearBtn.style.display = searchInput.value.length > 0 ? 'block' : 'none';
        // UX: Enter key dismisses keyboard/blurs input
        if (e.key === 'Enter') {
            searchInput.blur();
        }
        processSearchChange();
    });

   clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        searchInput.focus();
        clearBtn.style.display = 'none';
        applyFilters(true);
    });

    // Custom Install App logic removed. 
    // Users can use browser native "Add to Home Screen" functionality.

    function shareRecipe(e, title, link) {
        e.preventDefault(); 
        e.stopPropagation(); 
        if (navigator.share) {
            navigator.share({ title: title, url: link }).catch(console.error);
        } else {
            navigator.clipboard.writeText(link);
            alert("Link copied to clipboard!");
        }
    }
</script>

</body>
</html>
