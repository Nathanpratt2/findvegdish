<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Vegan Recipes</title>

    <!-- SEO & Social Meta Tags -->
    <meta id="metaDesc" name="description" content="Find fresh daily vegan recipes from top bloggers. Search by ingredients, diet types, or explore new plant-based dishes.">
    
    <link id="canonicalLink" rel="canonical" href="https://findvegdish.com/">
    <meta name="robots" content="index, follow, max-image-preview:large">

    <!-- Open Graph Tags (Now Dynamic via JS) -->
    <meta property="og:title" content="Daily Vegan Recipes">
    <meta property="og:description" content="Daily recipes from the top bloggers">
    <meta property="og:image" content="https://findvegdish.com/default.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://findvegdish.com">
    <meta property="og:type" content="website">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">

    <link rel="icon" href="https://findvegdish.com/icon.jpg" type="image/jpeg"> 
    <link rel="apple-touch-icon" href="https://findvegdish.com/icon.jpg">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
            padding-bottom: 60px;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .logo-link {
            display: inline-block;
            cursor: pointer;
            text-decoration: none;
            border: none;
            background: none;
        }

        .logo-img {
            max-width: 90%;
            width: 350px;
            height: auto;
            display: block;
            margin: 0 auto 3px auto;
            transition: transform 0.2s;
        }
        
        .logo-link:active .logo-img {
            transform: scale(0.98); 
        }
        
        h1.sub-intro {
            text-align: center;
            font-size: 0.9em;
            font-weight: 400;
            color: #888; 
            margin: -5px 0 15px 0; 
            line-height: 1.5;
        }

        /* --- SEARCH ROW STYLES --- */
        .search-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 480px;
            margin: 10px auto;
        }

        .search-wrapper {
            position: relative;
            flex-grow: 1;
        }

        #searchInput {
            padding: 12px 45px 12px 20px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 25px;
            border: 1px solid #ddd;
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            outline: none;
            transition: all 0.3s ease;
            color: #769F37; 
            font-weight: 600;
        }
        
        /* UI REQUEST: Hover Border */
        #searchInput:hover {
            border-color: #769F37;
        }

        #searchInput:focus {
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-color: #769F37;
        }
        #searchInput::placeholder {
            color: #aaa;
            font-weight: 400;
        }

        #clearBtn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            color: #aaa;
            cursor: pointer;
            display: none;
            padding: 5px;
        }
        #clearBtn:hover { color: #555; }

        /* --- SHUFFLE BUTTON --- */
        #shuffleIconBtn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: white; 
            border: 2px solid #769F37; 
            color: #769F37; 
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 22px;
            transition: all 0.2s ease;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #shuffleIconBtn:active {
            transform: scale(0.95);
        }
        @media (hover: hover) {
            #shuffleIconBtn:hover {
                background-color: #769F37;
                color: white;
                box-shadow: 0 4px 8px rgba(118, 159, 55, 0.3);
            }
        }

        /* --- SCROLLING CONTROLS --- */
        .controls {
            display: flex;
            align-items: center;
            gap: 10px; 
            margin-top: 15px;
            width: 100%;
            flex-wrap: nowrap; 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 5px; 
            scrollbar-width: none; 
            justify-content: flex-start;
            padding-left: 5px; 
            padding-right: 5px;
        }
        
        .controls::-webkit-scrollbar { display: none; }

        @media (min-width: 550px) {
            .controls {
                justify-content: center;
            }
        }
        
        @media (max-width: 549px) {
            .controls::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to right, rgba(248, 249, 250, 0), rgba(248, 249, 250, 1) 80%);
                pointer-events: none; 
            }
        }

        .btn {
            padding: 10px 18px; 
            border-radius: 25px;
            border: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.1s, background 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #555;
            background-color: white;
            border: 1px solid #ddd;
            -webkit-tap-highlight-color: transparent; 
            white-space: nowrap; 
            flex-shrink: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        @media (hover: hover) {
               .btn:hover { background-color: #f0f0f0; }
        }
        .btn:active { 
            transform: scale(0.95); 
            background-color: #e0e0e0;
        }

        .btn.active-filter {
            background-color: #769F37 !important; 
            color: white !important;
            border-color: #769F37 !important;
        }

        #installBtn {
            display: none;
            background-color: #2c3e50;
            color: white;
            border: none;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            margin-top: 25px;
            grid-auto-flow: row; 
        }
        
        @media (max-width: 1100px) { .gallery { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 800px) { .gallery { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 500px) { .gallery { grid-template-columns: 1fr; } }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            overflow: hidden;
            display: flex;
            flex-direction: column; 
            position: relative;
            animation: fadeIn 0.5s ease-in;
            height: 100%;
        }
        
        .card-link {
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        
        .card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }
        
        .share-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s, background 0.2s;
            border: none;
            outline: none;
            padding: 0;
        }
        .share-btn:hover { transform: scale(1.1); background-color: #f0f0f0; }
        .share-btn svg { width: 22px; height: 22px; fill: #555; }

        .info { 
            padding: 15px; 
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            align-items: flex-start; 
        }
        
        .meta-row {
            display: flex;
            align-items: center;
            gap: 8px; 
            margin-bottom: 5px;
            width: 100%;
            flex-wrap: wrap; 
        }
        
        .tag {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #769F37; 
            font-weight: 600;
            display: inline-block;
        }
        .disruptor-tag { color: #e67e22; }
        
        .fresh-badge, .wfpb-badge, .easy-badge, .budget-badge {
            color: white;
            font-size: 0.7em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        .fresh-badge {
            background-color: #769F37; 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; }
        }

        .wfpb-badge { background-color: #16a085; }
        .easy-badge { background-color: #2980b9; }
        .budget-badge { background-color: #8e44ad; }

        .title {
            font-size: 1.1em;
            font-weight: 600;
            line-height: 1.4;
            margin: 5px 0;
            color: #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* RECO B: Changed to match H2 tag */
        h2.title { margin: 5px 0; }
        
        .blogger { font-size: 0.9em; color: #888; margin-top: auto; padding-top: 10px; }
        
        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 1.2em;
            color: #888;
            margin-top: 40px;
        }

        footer { text-align: center; margin-top: 50px; color: #aaa; font-size: 0.9em; padding: 0 20px;}
        
        .footer-topics {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        .footer-topics a {
            color: #888;
            text-decoration: none;
            font-size: 0.85em;
        }
        .footer-topics a:hover {
            color: #769F37;
            text-decoration: underline;
        }

        #loader { text-align: center; padding: 20px; color: #888; font-style: italic; display: none; }

        #scrollTopBtn {
            display: none; 
            position: fixed;
            bottom: 95px;
            right: 18px;
            z-index: 99;
            width: 60px;
            height: 60px;
            border: none;
            outline: none;
            background-color: #769F37;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: background-color 0.3s, transform 0.3s;
            align-items: center;
            justify-content: center;
        }
        #scrollTopBtn:hover {
            background-color: #5d822b; 
            transform: translateY(-3px);
        }
        @media (max-width: 400px) {
            #scrollTopBtn { bottom: 90px; right: 18px; width: 50px; height: 50px; }
        }
    </style>
</head>
<body>

<header>
    <a href="index.html" class="logo-link" title="Refresh">
        <img src="default.jpg" alt="Daily Vegan Recipes" class="logo-img">
    </a>
    
    <!-- Static H1 preserved -->
    <h1 class="sub-intro">Explore the newest recipes from over 50 top blogs</h1>
    
    <div class="search-row">
        <button id="shuffleIconBtn" onclick="shuffleRecipes()" title="Shuffle Recipes">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="16 3 21 3 21 8"></polyline>
                <path d="M4 20c0-6 8-6 17-17"></path>
                <polyline points="21 16 21 21 16 21"></polyline>
                <path d="M4 4c0 6 8 6 17 17"></path>
            </svg>
        </button>
        
        <div class="search-wrapper">
            <label for="searchInput" style="display:none;">Search Recipes</label>
            <input type="text" id="searchInput" placeholder="Search: Soup, Blog, Protein...">
            <button id="clearBtn" title="Clear Search">‚úï</button>
        </div>
    </div>

    <div class="controls">
        <button class="btn" id="mealsBtn" onclick="toggleType('meal')">üçù Meals</button>
        <button class="btn" id="sweetsBtn" onclick="toggleType('sweet')">üç™ Sweets</button>
        <button class="btn" id="budgetBtn" onclick="toggleTag('Budget')">üí∏ Budget</button>
        <button class="btn" id="easyBtn" onclick="toggleTag('Easy')">‚ö° Easy</button>
        <button class="btn" id="proteinBtn" onclick="toggleTag('Protein')">‚¨ÜÔ∏è Protein</button>
        <button class="btn" id="wfpbBtn" onclick="toggleTag('WFPB')">ü•ó WFPB</button>
        <button class="btn" id="gfBtn" onclick="toggleTag('GF')">üåæ GF</button>        
    </div>
</header>

<main id="gallery" class="gallery"></main>
<div id="loader">Loading more recipes...</div>

<button id="scrollTopBtn" title="Go to top" aria-label="Scroll to top">
    <svg viewBox="0 0 24 24" width="30" height="30" fill="white">
        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
    </svg>
</button>

<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="natethevegan" data-description="Support me on Buy me a coffee!" data-message="" data-color="#769F37" data-position="Right" data-x_margin="18" data-y_margin="18"></script>

<footer>
    <p>Daily Vegan Recipes aggregates the best plant-based cooking from top bloggers. Discover easy vegan dinner ideas, high-protein plant-based meals, WFPB (Whole Food Plant Based) dishes, gluten-free sweets, and budget-friendly vegan food. Updated daily.</p>
    
    <div class="footer-topics">
        <a href="?q=pasta">Best Vegan Pasta</a>
        <a href="?q=tofu">Tofu Recipes</a>
        <a href="?q=soup">Vegan Soups</a>
        <a href="?q=salad">Healthy Salads</a>
        <a href="?q=curry">Plant-Based Curry</a>
        <a href="?q=breakfast">Vegan Breakfast</a>
        <a href="?q=protein">High Protein Vegan</a>
        <a href="?q=wfpb">Whole Food Plant Based</a>
        <a href="?q=gluten+free">Gluten Free Vegan</a>
        <a href="?q=budget">Budget Friendly</a>
        <a href="?q=dessert">Vegan Desserts</a>
    </div>
</footer>

<script>
    // --- GLOBAL STATE ---
    let allRecipes = [];          
    let currentContext = [];      
    let renderedCount = 0;        
    
    // Filtering State
    let activeType = null; // 'meal', 'sweet', or null
    let activeTags = new Set(); // Stores 'Budget', 'Easy'
    
    const BATCH_SIZE = 48;        

    // --- KEYWORDS ---
    const SWEET_KEYWORDS = ['cookie', 'cake', 'brownie', 'chocolate', 'dessert', 'pie', 'tart', 'muffin', 'donut', 'doughnut', 'ice cream', 'pudding', 'cheesecake', 'sweet', 'fudge', 'truffle', 'bar', 'cupcake', 'blondie', 'galette', 'cobbler', 'mousse', 'cinnamon roll', 'scone', 'waffle', 'pancake'];
    const MEAL_KEYWORDS = ['pasta', 'burger', 'curry', 'soup', 'stew', 'taco', 'pizza', 'sandwich', 'wrap', 'salad', 'bowl', 'rice', 'noodle', 'stir fry', 'lasagna', 'casserole', 'tofu', 'tempeh', 'lentil', 'chickpea', 'potato', 'dinner', 'lunch', 'roast', 'chili', 'shepherd', 'risotto', 'gnocchi', 'quiche', 'enchilada', 'burrito', 'quesadilla', 'mac and cheese', 'dumpling', 'meatball', 'loaf', 'skillet', 'gratin', 'pad thai', 'ramen'];
    const PROTEIN_KEYWORDS = ['tofu', 'tempeh', 'seitan', 'tvp', 'lentil', 'bean', 'chickpea', 'edamame', 'soy', 'quinoa', 'peanut', 'meatball', 'burger', 'sausage', 'protein', 'falafel', 'hummus', 'nut roast'];

    // --- UTILS ---
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // --- INITIALIZATION ---
    fetch('data.json?v=' + new Date().getTime())
        .then(response => response.json())
        .then(data => {
            allRecipes = data;
            currentContext = allRecipes; 
            
            injectStaticSchema(allRecipes);
            setupInfiniteScroll();   
            
            // Check URL for initial state (Deep Linking)
            parseURLState();
        })
        .catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('gallery').innerHTML = '<p style="text-align:center">Could not load recipes.</p>';
        });

    // Handle Browser Back Button
    window.addEventListener('popstate', () => {
        parseURLState();
    });

    // --- URL & SEO LOGIC (Updated) ---

    // 1. Read URL params and set UI
    function parseURLState() {
        const params = new URLSearchParams(window.location.search);
        
        // Reset Logic
        activeType = null;
        activeTags.clear();
        document.getElementById('mealsBtn').classList.remove('active-filter');
        document.getElementById('sweetsBtn').classList.remove('active-filter');
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active-filter'));
        document.getElementById('searchInput').value = '';

        // Apply URL Params
        if (params.has('q')) {
            document.getElementById('searchInput').value = params.get('q');
            document.getElementById('clearBtn').style.display = 'block';
        }

        if (params.has('type')) {
            const type = params.get('type');
            activeType = type;
            if (type === 'meal') document.getElementById('mealsBtn').classList.add('active-filter');
            if (type === 'sweet') document.getElementById('sweetsBtn').classList.add('active-filter');
        }

        if (params.has('tag')) {
            const tags = params.get('tag').split(',');
            tags.forEach(t => {
                activeTags.add(t);
                const btn = document.getElementById(t.toLowerCase() + 'Btn');
                if (btn) btn.classList.add('active-filter');
            });
        }

        // Apply filters but do NOT push new state (avoid loop)
        applyFilters(false); 
    }

    // 2. Update URL History
    function updateURL() {
        const params = new URLSearchParams();
        const searchVal = document.getElementById('searchInput').value;
        
        if (searchVal) params.set('q', searchVal);
        if (activeType) params.set('type', activeType);
        if (activeTags.size > 0) params.set('tag', Array.from(activeTags).join(','));

        const newURL = params.toString() ? `?${params.toString()}` : window.location.pathname;
        history.pushState({}, '', newURL);
        
        // Update Canonical Link dynamically
        const canonical = document.getElementById('canonicalLink');
        if (canonical) canonical.href = "https://findvegdish.com/" + newURL;
    }

    // 3. Update Title, Meta Description, Breadcrumb, and Open Graph
    function updateSEO(currentRecipes = []) {
        let title = "Daily Vegan Recipes";
        let desc = "Find fresh daily vegan recipes from top bloggers.";
        let breadcrumbName = "Home";
        
        const searchVal = document.getElementById('searchInput').value;
        const tagsArr = Array.from(activeTags);

        // Logic to build title
        if (searchVal) {
            title = `${searchVal} - Search | Daily Vegan Recipes`;
            desc = `Best vegan recipes matching "${searchVal}".`;
            breadcrumbName = `Search: ${searchVal}`;
        } else if (activeType === 'meal') {
            title = "Vegan Dinner & Meal Ideas | Daily Vegan Recipes";
            desc = "Discover savory vegan meals, dinners, and lunch ideas from top plant-based blogs.";
            breadcrumbName = "Meals";
        } else if (activeType === 'sweet') {
            title = "Vegan Sweets & Desserts | Daily Vegan Recipes";
            desc = "Indulge in the best vegan desserts, cookies, cakes, and sweets.";
            breadcrumbName = "Sweets";
        } else if (tagsArr.length > 0) {
            const primaryTag = tagsArr[0];
            title = `${primaryTag} Vegan Recipes | Daily Vegan Recipes`;
            desc = `Top rated ${primaryTag} vegan recipes updated daily.`;
            breadcrumbName = primaryTag;
        }

        // Update DOM Title and Meta Desc
        document.title = title;
        const metaDesc = document.getElementById('metaDesc');
        if (metaDesc) metaDesc.content = desc;

        // RECO C: Update Open Graph Tags
        const ogTitle = document.querySelector('meta[property="og:title"]');
        const ogDesc = document.querySelector('meta[property="og:description"]');
        const ogUrl = document.querySelector('meta[property="og:url"]');
        
        if (ogTitle) ogTitle.content = title;
        if (ogDesc) ogDesc.content = desc;
        if (ogUrl) ogUrl.content = window.location.href;

        // Dynamic Breadcrumb Schema
        updateBreadcrumbSchema(breadcrumbName);
        
        // RECO A: Update ItemList Schema (Structured Data)
        updateItemListSchema(currentRecipes);
    }

    function updateBreadcrumbSchema(currentItemName) {
        // Remove old dynamic schema
        const oldScript = document.getElementById('dynamic-schema');
        if (oldScript) oldScript.remove();

        if (currentItemName === "Home") return;

        const schema = {
            "@context": "https://schema.org",
            "@type": "BreadcrumbList",
            "itemListElement": [{
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": "https://findvegdish.com/"
            }, {
                "@type": "ListItem",
                "position": 2,
                "name": currentItemName,
                "item": window.location.href
            }]
        };

        const script = document.createElement('script');
        script.id = 'dynamic-schema';
        script.type = 'application/ld+json';
        script.text = JSON.stringify(schema);
        document.head.appendChild(script);
    }

    // RECO A: Generate ItemList Schema for the filtered results
    function updateItemListSchema(recipes) {
        const oldScript = document.getElementById('item-list-schema');
        if (oldScript) oldScript.remove();

        if (!recipes || recipes.length === 0) return;

        // SEO Constraint: Limit to top 20 items to avoid excessive payload
        const topRecipes = recipes.slice(0, 20);

        const schema = {
            "@context": "https://schema.org",
            "@type": "ItemList",
            "itemListElement": topRecipes.map((recipe, index) => ({
                "@type": "ListItem",
                "position": index + 1,
                "url": recipe.link,
                "name": recipe.title,
                "image": recipe.image
            }))
        };

        const script = document.createElement('script');
        script.id = 'item-list-schema';
        script.type = 'application/ld+json';
        script.text = JSON.stringify(schema);
        document.head.appendChild(script);
    }

    function injectStaticSchema(recipes) {
        // WebSite Schema
        const searchSchema = {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "url": "https://findvegdish.com/",
            "potentialAction": {
                "@type": "SearchAction",
                "target": "https://findvegdish.com/?q={search_term_string}",
                "query-input": "required name=search_term_string"
            }
        };

        const scriptSearch = document.createElement('script');
        scriptSearch.type = 'application/ld+json';
        scriptSearch.text = JSON.stringify(searchSchema);
        document.head.appendChild(scriptSearch);
    }

    // --- RENDER LOGIC (BATCHED) ---
    function renderNextBatch() {
        const gallery = document.getElementById('gallery');
        const loader = document.getElementById('loader');
        
        if (currentContext.length === 0) {
            gallery.innerHTML = '<div class="no-results">No recipes found. Try a different combination!</div>';
            loader.style.display = 'none';
            return;
        }

        if (renderedCount >= currentContext.length) {
            loader.style.display = 'none';
            return;
        }

        const nextBatch = currentContext.slice(renderedCount, renderedCount + BATCH_SIZE);
        
        nextBatch.forEach(recipe => {
            const card = createCard(recipe);
            gallery.appendChild(card);
        });

        renderedCount += nextBatch.length;
        
        if (renderedCount < currentContext.length) {
            loader.style.display = 'block';
        } else {
            loader.style.display = 'none';
        }
    }

    function createCard(recipe) {
        const card = document.createElement('article');
        card.className = 'card';

        const link = document.createElement('a');
        link.className = 'card-link';
        link.href = recipe.link;
        link.target = "_blank"; 
        link.rel = "noopener noreferrer";

        const img = document.createElement('img');
        img.src = recipe.image;
        
        // CLS IMPROVEMENT: Explicit width/height to reserve space
        img.width = 400;
        img.height = 250; 
        
        img.alt = `${recipe.title} - Vegan Recipe by ${recipe.blog_name}`;
        img.loading = "lazy"; 
        img.referrerPolicy = "no-referrer";

        img.onerror = function() { 
            this.onerror = null; 
            this.src = 'icon.jpg'; 
        };

        const info = document.createElement('div');
        info.className = 'info';

        let tagClass = 'tag';
        let tagText = 'Top Blog';
        if(recipe.is_disruptor) {
            tagClass += ' disruptor-tag';
            tagText = 'Rising Blog';
        }

        const recipeDate = new Date(recipe.date);
        const now = new Date();
        const hoursOld = (now - recipeDate) / (1000 * 3600);
        
        let badgeHTML = '';
        if (hoursOld < 20) {
            badgeHTML += '<span class="fresh-badge">New Today</span>';
        }

        if (recipe.special_tags && Array.isArray(recipe.special_tags)) {
            recipe.special_tags.forEach(tag => {
                if (tag === 'WFPB') {
                    badgeHTML += '<span class="wfpb-badge">WFPB</span>';
                } else if (tag === 'Easy') {
                    badgeHTML += '<span class="easy-badge">Easy</span>';
                } else if (tag === 'Budget') {
                    badgeHTML += '<span class="budget-badge">Budget</span>';
                }
            });
        }
        
        // RECO B: Changed h3.title to h2.title for better SEO Hierarchy (H1 -> H2)
        info.innerHTML = `
            <div class="meta-row">
                <span class="${tagClass}">${tagText}</span>
                ${badgeHTML}
            </div>
            <h2 class="title" title="${recipe.title}">${recipe.title}</h2>
            <div class="blogger">by ${recipe.blog_name}</div>
        `;

        const shareBtn = document.createElement('button');
        shareBtn.className = 'share-btn';
        shareBtn.ariaLabel = "Share Recipe";
        shareBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>`;
        shareBtn.onclick = (e) => shareRecipe(e, recipe.title, recipe.link);

        link.appendChild(img);
        link.appendChild(info);
        card.appendChild(shareBtn);
        card.appendChild(link);
        
        return card;
    }

    // --- INFINITE SCROLL ---
    function setupInfiniteScroll() {
        window.addEventListener('scroll', () => {
            const scrollBtn = document.getElementById("scrollTopBtn");
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                scrollBtn.style.display = "flex";
            } else {
                scrollBtn.style.display = "none";
            }
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                if (renderedCount < currentContext.length) {
                    renderNextBatch();
                }
            }
        });
        document.getElementById("scrollTopBtn").addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    function resetView(newContext) {
        currentContext = newContext;
        renderedCount = 0;
        document.getElementById('gallery').innerHTML = '';
        renderNextBatch();
    }

    // --- SHUFFLE ---
    function shuffleRecipes() {
        document.activeElement.blur(); 
        for (let i = allRecipes.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allRecipes[i], allRecipes[j]] = [allRecipes[j], allRecipes[i]];
        }
        applyFilters(true);
    }

    // --- FILTER & LOGIC ---
    
    function toggleType(type) {
        document.activeElement.blur();
        const mealsBtn = document.getElementById('mealsBtn');
        const sweetsBtn = document.getElementById('sweetsBtn');

        if (activeType === type) {
            activeType = null;
            mealsBtn.classList.remove('active-filter');
            sweetsBtn.classList.remove('active-filter');
        } else {
            activeType = type;
            if (type === 'meal') {
                mealsBtn.classList.add('active-filter');
                sweetsBtn.classList.remove('active-filter');
            } else {
                sweetsBtn.classList.add('active-filter');
                mealsBtn.classList.remove('active-filter');
            }
        }
        applyFilters(true);
    }

    function toggleTag(tagName) {
        document.activeElement.blur();
        const btnId = tagName.toLowerCase() + 'Btn';
        const btn = document.getElementById(btnId);

        if (activeTags.has(tagName)) {
            activeTags.delete(tagName);
            btn.classList.remove('active-filter');
        } else {
            activeTags.add(tagName);
            btn.classList.add('active-filter');
        }
        applyFilters(true);
    }

    function applyFilters(pushState = true) {
        const rawInput = document.getElementById('searchInput').value;
        const term = rawInput.toLowerCase().replace(/-/g, ' '); 
        
        const SAVORY_EXCEPTIONS = ['sweet potato', 'sweet and sour', 'sweet corn', 'sweet pea', 'sweet chili', 'sweet pepper'];
        const SWEET_EXCEPTIONS = ['rice', 'instant pot', 'crock pot', 'one pot', 'cup', 'butter', 'nut']; 

        let filtered = allRecipes;

        // A. Search Bar Logic
        if (term.length > 0) {
            filtered = filtered.filter(recipe => {
                if (term === 'protein') {
                    const t = recipe.title.toLowerCase();
                    return PROTEIN_KEYWORDS.some(k => t.includes(k));
                }

                const title = recipe.title.toLowerCase().replace(/-/g, ' ');
                const blogger = recipe.blog_name.toLowerCase().replace(/-/g, ' ');
                
                let hasMatchingTag = false;
                if (recipe.special_tags && Array.isArray(recipe.special_tags)) {
                    hasMatchingTag = recipe.special_tags.some(tag => 
                        tag.toLowerCase().replace(/-/g, ' ').includes(term)
                    );
                }
                
                return title.includes(term) || blogger.includes(term) || hasMatchingTag;
            });
        }

        // B. Meal vs Sweet Logic
        if (activeType === 'meal') {
            filtered = filtered.filter(recipe => {
                const t = recipe.title.toLowerCase();
                const hasMealKeyword = MEAL_KEYWORDS.some(k => t.includes(k));
                const hasSweetKeyword = SWEET_KEYWORDS.some(k => t.includes(k));
                const isSavoryException = SAVORY_EXCEPTIONS.some(k => t.includes(k));
                const isSide = t.includes('sauce') || t.includes('dressing') || t.includes('side') || t.includes('treats');
                return hasMealKeyword && (!hasSweetKeyword || isSavoryException) && !isSide;
            });
        } else if (activeType === 'sweet') {
            filtered = filtered.filter(recipe => {
                const t = recipe.title.toLowerCase();
                const hasSweetKeyword = SWEET_KEYWORDS.some(k => t.includes(k));
                const hasMealKeyword = MEAL_KEYWORDS.some(k => t.includes(k));
                const isSweetException = SWEET_EXCEPTIONS.some(k => t.includes(k));
                const isSavory = t.includes('spicy') || t.includes('chili') || t.includes("shepherd's") || t.includes('egg') || t.includes('burger');
                const isExplicitlySavory = SAVORY_EXCEPTIONS.some(k => t.includes(k));
                return hasSweetKeyword && (!hasMealKeyword || isSweetException) && !isExplicitlySavory && !isSavory;
            });
        }

        // C. Tag Logic
        if (activeTags.size > 0) {
            filtered = filtered.filter(recipe => {
                const title = recipe.title.toLowerCase();
                
                for (let tag of activeTags) {
                    if (tag === 'Protein') {
                        if (!PROTEIN_KEYWORDS.some(k => title.includes(k))) return false;
                    } 
                    else if (tag === 'GF') {
                        const isGF = title.includes('gf') || title.includes('gluten free') || title.includes('gluten-free');
                        if (!isGF) return false;
                    } 
                    else {
                        if (!recipe.special_tags || !recipe.special_tags.includes(tag)) return false;
                    }
                }
                return true;
            });
        }

        // Apply SEO and URL changes
        if (pushState) {
            updateURL();
        }
        
        // Pass the filtered list to updateSEO so it can generate ItemList schema
        updateSEO(filtered);

        resetView(filtered);
    }

    const processSearchChange = debounce(() => {
        applyFilters(true);
    }, 300);

    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');

    searchInput.addEventListener('keyup', () => {
        clearBtn.style.display = searchInput.value.length > 0 ? 'block' : 'none';
        processSearchChange();
    });

    clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        searchInput.focus();
        clearBtn.style.display = 'none';
        applyFilters(true);
    });

    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if(installBtn) installBtn.style.display = 'inline-block';
    });
    if(installBtn) {
        installBtn.addEventListener('click', (e) => {
            installBtn.style.display = 'none';
            deferredPrompt.prompt();
            deferredPrompt = null;
        });
    }

    function shareRecipe(e, title, link) {
        e.preventDefault(); 
        e.stopPropagation(); 
        if (navigator.share) {
            navigator.share({ title: title, url: link }).catch(console.error);
        } else {
            navigator.clipboard.writeText(link);
            alert("Link copied to clipboard!");
        }
    }
</script>

</body>
</html>
