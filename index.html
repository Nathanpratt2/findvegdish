<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Vegan Recipes</title>

    <!-- SEO & Social Meta Tags -->
    <meta id="metaDesc" name="description" content="Find fresh daily vegan recipes from top bloggers. Search by ingredients, diet types, or explore new plant-based dishes.">
    
    <link id="canonicalLink" rel="canonical" href="https://searchveg.com/">
    <meta name="robots" content="index, follow, max-image-preview:large">

    <!-- PERFORMANCE: Preload Critical Data Source -->
    <link rel="preload" href="data.json" as="fetch" crossorigin>

    <!-- 1. STATIC SCHEMA MIGRATION: WebSite & SearchAction -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "url": "https://searchveg.com/",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://searchveg.com/?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>

    <!-- Open Graph Tags (Dynamic via JS) -->
    <meta property="og:title" content="Daily Vegan Recipes">
    <meta property="og:description" content="Daily recipes from the top bloggers">
    <meta property="og:image" content="https://searchveg.com/default.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://searchveg.com">
    <meta property="og:type" content="website">
    
    <link rel="manifest" href="https://searchveg.com/manifest.json">
    <meta name="theme-color" content="#ffffff">

    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #333;
            --text-muted: #888;
            --card-bg: #ffffff;
            --input-bg: #ffffff;
            --input-border: #ddd;
            --input-text: #769F37;
            --shadow-color: rgba(0,0,0,0.1);
            --accent-color: #769F37;
        }

        /* --- DARK MODE VARIABLES --- */
        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --text-muted: #aaa;
            --card-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --input-border: #444;
            --input-text: #98c94e;
            --shadow-color: rgba(0,0,0,0.5);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            padding-bottom: 60px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .logo-link {
            display: inline-block;
            cursor: pointer;
            text-decoration: none;
            border: none;
            background: none;
            /* Disable user select to prevent highlighting during long press */
            user-select: none; 
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .logo-img {
            max-width: 90%;
            width: 350px;
            height: auto;
            display: block;
            margin: 0 auto 3px auto;
            transition: transform 0.2s;
            border-radius: 12px; /* Smooth corners in case it's a JPG in dark mode */
        }
        
        body.dark-mode .logo-img {
            filter: brightness(0.9); /* Slightly dim logo in dark mode */
        }
        
        .logo-link:active .logo-img {
            transform: scale(0.98); 
        }
        
        .sub-intro {
            text-align: center;
            font-size: 0.9em;
            font-weight: 400;
            color: var(--text-muted); 
            margin: -5px 0 15px 0; 
            line-height: 1.5;
        }

        /* --- SEARCH ROW STYLES --- */
        .search-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 480px;
            margin: 10px auto;
        }

        .search-wrapper {
            position: relative;
            flex-grow: 1;
        }

        #searchInput {
            /* Adjusted padding right to accommodate both buttons */
            padding: 12px 80px 12px 20px; 
            width: 100%;
            box-sizing: border-box;
            border-radius: 25px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            outline: none;
            transition: all 0.3s ease;
            color: var(--input-text); 
            font-weight: 600;
        }
        
        #searchInput:hover {
            border-color: var(--accent-color);
        }

        #searchInput:focus {
            box-shadow: 0 4px 10px var(--shadow-color);
            border-color: var(--accent-color);
        }
        #searchInput::placeholder {
            color: #aaa;
            font-weight: 400;
        }

        /* Common style for search bar buttons */
        .search-bar-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: none; /* Hidden by default */
            padding: 5px;
            color: #aaa;
            transition: color 0.2s;
        }
        .search-bar-btn svg {
            display: block;
            fill: currentColor;
        }
        
        #shareSearchBtn {
            right: 46px; 
            font-size: 16px;
        }

        #clearBtn {
            right: 12px;
        }

        /* --- SHUFFLE BUTTON --- */
        #shuffleIconBtn {
            width: 48px;
            height: 48px;
            border-radius: 50%; 
            background-color: var(--card-bg); 
            border: 1px solid var(--input-border); 
            color: var(--accent-color); 
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #shuffleIconBtn:active {
            transform: scale(0.95);
        }
        @media (hover: hover) {
            #shuffleIconBtn:hover {
                background-color: var(--accent-color);
                border-color: var(--accent-color); 
                color: white;
                box-shadow: 0 4px 8px rgba(118, 159, 55, 0.3);
            }
        }

        @keyframes jiggle {
            0%, 100% { transform: rotate(0deg); }
            15% { transform: rotate(-12deg); }
            30% { transform: rotate(12deg); }
            45% { transform: rotate(-9deg); }
            60% { transform: rotate(9deg); }
            75% { transform: rotate(-5deg); }
            90% { transform: rotate(5deg); }
        }
        .jiggle {
            animation: jiggle 1s ease-in-out;
        }

        /* --- SCROLLING CONTROLS --- */
        .controls {
            display: flex;
            align-items: center;
            gap: 10px; 
            margin-top: 15px;
            width: 100%;
            flex-wrap: nowrap; 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 5px; 
            scrollbar-width: none; 
            justify-content: flex-start;
            padding-left: 5px; 
            padding-right: 5px;
        }
        
        .controls::-webkit-scrollbar { display: none; }

        /* --- CUISINE SUB-MENU STYLES --- */
        .sub-controls-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s ease;
            width: 100%;
        }
        .sub-controls-wrapper.open {
            grid-template-rows: 1fr;
        }
        .sub-controls {
            overflow: hidden;
        }
        .sub-controls-inner {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 5px 15px 5px;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            justify-content: flex-start;
        }
        .sub-controls-inner::-webkit-scrollbar { display: none; }
        
        .dropdown-arrow {
            transition: transform 0.3s ease;
            width: 16px;
            height: 16px;
            fill: currentColor;
            margin-left: -2px;
        }
        .dropdown-arrow.open {
            transform: rotate(180deg);
        }

        @media (min-width: 550px) {
            .controls, .sub-controls-inner {
                justify-content: center;
            }
        }
        
        @media (max-width: 549px) {
            .controls::after, .sub-controls-inner::after {
                content: '';
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to right, rgba(248, 249, 250, 0), var(--bg-color) 80%);
                pointer-events: none; 
            }
            .sub-controls-inner::after {
                z-index: 10;
            }
        }

        .btn {
            padding: 10px 18px; 
            border-radius: 25px;
            border: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.1s, background 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #555;
            background-color: var(--card-bg);
            border: 1px solid var(--input-border);
            -webkit-tap-highlight-color: transparent; 
            white-space: nowrap; 
            flex-shrink: 0; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-decoration: none; 
        }
        @media (hover: hover) {
               .btn:hover { background-color: #f0f0f0; }
        }
        /* Dark mode hover fix */
        body.dark-mode .btn {
            color: #ffffff; /* Makes text white in dark mode */
            background-color: #2d2d2d; /* Slightly lighter than the background */
        }
        body.dark-mode .btn:hover { 
            background-color: #444; 
            color: #ffffff; 
        }

        .btn:active { 
            transform: scale(0.95); 
            background-color: #e0e0e0;
        }
        body.dark-mode .btn:active { background-color: #444; }

        .btn.active-filter {
            background-color: var(--accent-color) !important; 
            color: white !important;
            border-color: var(--accent-color) !important;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            margin-top: 25px;
            grid-auto-flow: row; 
            min-height: 500px; 
        }
        
        @media (max-width: 1100px) { .gallery { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 800px) { .gallery { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 500px) { .gallery { grid-template-columns: 1fr; } }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px var(--shadow-color);
            transition: transform 0.2s, background-color 0.3s;
            overflow: hidden;
            display: flex;
            flex-direction: column; 
            position: relative;
            animation: fadeIn 0.5s ease-in;
            height: 100%;
            content-visibility: auto;
            contain-intrinsic-size: 400px; 
        }
        
        .card-link {
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        
        .card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }
        
       /* --- ACTION BUTTONS (Heart & Share) --- */
        .action-btn {
            position: absolute;
            right: 10px;
            background: var(--card-bg);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s, background 0.2s;
            border: none;
            outline: none;
            padding: 0;
        }
        
        .heart-btn { top: 10px; }
        .share-btn { top: 64px; } /* Shifted down */

        .action-btn:hover { transform: scale(1.1); background-color: #f0f0f0; }
        body.dark-mode .action-btn:hover { background-color: #444; }

        .share-btn svg { width: 22px; height: 22px; fill: #555; }
        body.dark-mode .share-btn svg { fill: #ddd; }

        .heart-btn svg { width: 24px; height: 24px; fill: none; stroke: #888; stroke-width: 2; transition: all 0.2s; }
        
        /* Active Heart State */
        .heart-btn.active svg {
            fill: var(--accent-color); /* Brand Green */
            stroke: var(--accent-color);
            animation: heartPop 0.3s ease-out;
        }
        
        @keyframes heartPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Dimmed state for un-favoriting inside Saved View */
        .card.dimmed { opacity: 0.5; transition: opacity 0.3s; }

        .info { 
            padding: 15px; 
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            align-items: flex-start; 
        }
        
        .meta-row {
            display: flex;
            align-items: center;
            gap: 8px; 
            margin-bottom: 5px;
            width: 100%;
            flex-wrap: wrap; 
        }
        
        .tag {
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-color); 
            font-weight: 600;
            display: inline-block;
        }
        .disruptor-tag { color: #e67e22; }
        
        .fresh-badge, .wfpb-badge, .easy-badge, .budget-badge, .gf-badge {
            color: white;
            font-size: 0.7em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        .fresh-badge {
            background-color: var(--accent-color); 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; }
        }

        .wfpb-badge { background-color: #16a085; }
        .easy-badge { background-color: #2980b9; }
        .budget-badge { background-color: #8e44ad; }
        .gf-badge { background-color: #f39c12; }

        .title {
            font-size: 1.1em;
            font-weight: 600;
            line-height: 1.4;
            margin: 5px 0;
            color: var(--text-color);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        h2.title { margin: 5px 0; }
        
        .blogger { font-size: 0.9em; color: var(--text-muted); margin-top: auto; padding-top: 10px; }
        
        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 1.2em;
            color: var(--text-muted);
            margin-top: 40px;
        }

        /* --- SKELETON LOADING STYLES --- */
        .skeleton-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px var(--shadow-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 400px;
        }
        .skeleton-img {
            width: 100%;
            height: 250px;
            background-color: #eee;
            animation: skeleton-pulse 1.5s infinite ease-in-out;
        }
        body.dark-mode .skeleton-img { background-color: #333; }
        
        .skeleton-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .skeleton-text {
            height: 20px;
            background-color: #eee;
            border-radius: 4px;
            animation: skeleton-pulse 1.5s infinite ease-in-out;
        }
        body.dark-mode .skeleton-text { background-color: #333; }

        .w-60 { width: 60%; }
        .w-80 { width: 80%; }
        .w-40 { width: 40%; }
        
        @keyframes skeleton-pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        footer { text-align: center; margin-top: 50px; color: var(--text-muted); font-size: 0.9em; padding: 0 20px;}
        
        .footer-topics {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
        }
        body.dark-mode .footer-topics { border-top-color: #444; }

        .footer-topics a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.85em;
        }
        .footer-topics a:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

        #loader { text-align: center; padding: 20px; color: var(--text-muted); font-style: italic; display: none; }

        #scrollTopBtn {
            display: none; 
            position: fixed;
            bottom: 95px;
            right: 18px;
            z-index: 99;
            width: 66px;
            height: 66px;
            border: none;
            outline: none;
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: background-color 0.3s, transform 0.3s;
            align-items: center;
            justify-content: center;
        }
        #scrollTopBtn:hover {
            background-color: #5d822b; 
            transform: translateY(-3px);
        }
        @media (max-width: 400px) {
            #scrollTopBtn { bottom: 90px; right: 18px; width: 55px; height: 55px; }
        }

        /* --- SAVED LIST SHARE BUTTON --- */
        #shareSavedBtn {
            padding: 0;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            border: none;
            justify-content: center;
            display: none; /* Hidden by default */
            transition: background-color 0.2s, transform 0.1s;
        }
        #shareSavedBtn svg {
            fill: white;
            width: 20px;
            height: 20px;
        }
        #shareSavedBtn:hover {
            background-color: #5d822b;
        }
        #shareSavedBtn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
<script>
    // PRELOAD THEME: Run immediately to prevent "flash of white"
    if(localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
    }
</script>

<header>
    <h1 class="sr-only">Daily Vegan Recipes</h1>

    <a href="index.html" class="logo-link" title="Refresh">
        <!-- 4. IMAGE OPTIMIZATION: FetchPriority High & Async Decoding for LCP -->
        <img src="default.jpg" alt="Daily Vegan Recipes" class="logo-img" fetchpriority="high" decoding="async">
    </a>
    
    <p class="sub-intro">Discover thousands of recipes from 100+ creators</p>
    
    <div class="search-row">
        <button id="shuffleIconBtn" onclick="shuffleRecipes()" title="Shuffle Recipes">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
  <!-- Arrowheads (Placed at the end of the lines) -->
  <polyline points="17 4 21 7 17 10" />
  <polyline points="17 14 21 17 17 20" />
  
  <!-- Top-Left to Bottom-Right Path (Stops at x=17) -->
  <path d="M3 7h3c2.5 0 4.5 10 7.5 10h3.5" />
  
  <!-- Bottom-Left to Top-Right Path (Stops at x=17) -->
  <path d="M3 17h3c2.5 0 4.5-10 7.5-10h3.5" />
</svg>
        </button>
        
        <div class="search-wrapper">
            <label for="searchInput" style="display:none;">Search Recipes</label>
            <!-- 5. INPUT UX: Input Mode and Enter Key Hint -->
            <input type="text" id="searchInput" placeholder="Search: Pancakes, Blog, Tofu..." inputmode="search" enterkeyhint="search">
            
            <!-- NEW SHARE BUTTON -->
            <button id="shareSearchBtn" class="search-bar-btn" title="Share this search URL" aria-label="Share Search">
    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
    </svg>
</button>
            
            <button id="clearBtn" class="search-bar-btn" title="Clear Search">‚úï</button>
        </div>
    </div>

    <div class="controls">
        <button id="installBtn" class="btn" style="display:none; color: #769F37; border-color: #769F37;" onclick="installPWA()">üì≤ Install App</button>
        <!-- SAVED BUTTON -->
        <a href="?view=saved" class="btn" id="savedBtn" onclick="toggleSavedView(event)">üíö Saved (0)</a>
        
        <!-- NEW SHARE LIST BUTTON -->
        <button id="shareSavedBtn" class="btn" onclick="shareSavedList()" title="Share List" style="display:none;">
            <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
        </button>

        <a href="?type=meal" class="btn" id="mealsBtn" onclick="toggleType(event, 'meal')">üçù Meals</a>
        <a href="?type=sweet" class="btn" id="sweetsBtn" onclick="toggleType(event, 'sweet')">üç™ Sweets</a>
        <a href="?tag=Budget" class="btn" id="budgetBtn" onclick="toggleTag(event, 'Budget')">üí∏ Budget</a>
        <a href="?tag=Easy" class="btn" id="easyBtn" onclick="toggleTag(event, 'Easy')">‚ö° Easy</a>
        
        <!-- NEW CUISINE BUTTON -->
        <button id="cuisinesBtn" class="btn" onclick="toggleCuisineMenu(event)">
            üåé Cuisines
            <svg class="dropdown-arrow" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
        </button>

        <a href="?tag=Protein" class="btn" id="proteinBtn" onclick="toggleTag(event, 'Protein')">‚¨ÜÔ∏è Protein</a>
        <a href="?tag=WFPB" class="btn" id="wfpbBtn" onclick="toggleTag(event, 'WFPB')">ü•ó WFPB</a>
        <a href="?tag=GF" class="btn" id="gfBtn" onclick="toggleTag(event, 'GF')">üåæ GF</a>        
    </div>

    <!-- NEW HORIZONTAL SCROLLING CHIPS (HIDDEN BY DEFAULT) -->
    <div id="subControlsWrapper" class="sub-controls-wrapper">
        <div class="sub-controls">
            <div class="sub-controls-inner" id="cuisineChips">
                <button class="btn cuisine-btn" data-cuisine="Indian" onclick="toggleCuisine(event, 'Indian')">Indian</button>
                <button class="btn cuisine-btn" data-cuisine="Mexican" onclick="toggleCuisine(event, 'Mexican')">Mexican</button>
                <button class="btn cuisine-btn" data-cuisine="Italian" onclick="toggleCuisine(event, 'Italian')">Italian</button>
                <button class="btn cuisine-btn" data-cuisine="Asian" onclick="toggleCuisine(event, 'Asian')">Asian</button>
                <button class="btn cuisine-btn" data-cuisine="Middle Eastern" onclick="toggleCuisine(event, 'Middle Eastern')">Middle Eastern</button>
                <button class="btn cuisine-btn" data-cuisine="Mediterranean" onclick="toggleCuisine(event, 'Mediterranean')">Mediterranean</button>
            </div>
        </div>
    </div>
</header>

<!-- 7. SEMANTIC OUTLINE: aria-busy indicates loading state -->
<main id="gallery" class="gallery" aria-busy="true" aria-label="Recipe Gallery">
    <!-- SEO & PERFORMANCE: Skeleton Screens for Layout Stability & Initial Crawl -->
    <noscript>
        <div style="grid-column: 1 / -1; text-align: center; padding: 20px;">
            <h3>Explore Categories:</h3>
            <p>
                <a href="?type=meal">Vegan Meals</a> | 
                <a href="?type=sweet">Vegan Sweets</a> | 
                <a href="?tag=Budget">Budget Recipes</a> | 
                <a href="?tag=Easy">Easy Recipes</a>
            </p>
        </div>
    </noscript>
    
    <!-- 7. SEMANTIC OUTLINE: Skeletons as hidden articles -->
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
    <article class="skeleton-card" aria-hidden="true"><div class="skeleton-img"></div><div class="skeleton-info"><div class="skeleton-text w-40"></div><div class="skeleton-text w-80"></div><div class="skeleton-text w-60"></div></div></article>
</main>
<div id="loader">Loading more recipes...</div>

<button id="scrollTopBtn" title="Go to top" aria-label="Scroll to top">
    <svg viewBox="0 0 24 24" width="30" height="30" fill="white">
        <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
    </svg>
</button>

<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="natethevegan" data-description="Support me on Buy me a coffee!" data-message="" data-color="#769F37" data-position="Right" data-x_margin="18" data-y_margin="18"></script>

<footer>
    <p>Daily Vegan Recipes aggregates the best plant-based cooking from top bloggers. Discover easy vegan dinner ideas, high-protein plant-based meals, WFPB (Whole Food Plant Based) dishes, gluten-free sweets, and budget-friendly vegan food. Updated daily.</p>
    
    <div class="footer-topics">
        <a href="?q=pasta">Best Vegan Pasta</a>
        <a href="?q=tofu">Tofu Recipes</a>
        <a href="?q=soup">Vegan Soups</a>
        <a href="?q=salad">Healthy Salads</a>
        <a href="?q=curry">Plant-Based Curry</a>
        <a href="?q=breakfast">Vegan Breakfast</a>
        <a href="?q=protein">High Protein Vegan</a>
        <a href="?q=wfpb">Whole Food Plant Based</a>
        <a href="?q=gluten+free">Gluten Free Vegan</a>
        <a href="?q=budget">Budget Friendly</a>
        <a href="?q=dessert">Vegan Desserts</a>
    </div>
</footer>

<script>
   // --- GLOBAL STATE ---
    let allRecipes = [];          
    let currentContext = [];      
    let renderedCount = 0;        
    
    // Favorites State
    let savedRecipesMap = new Map(); // Link -> Recipe Object
    let isSavedView = false;   

   // --- WHIMSICAL: TYPEWRITER SEARCH PLACEHOLDERS ---
    const vibes = [
        "Search: Pancakes, Blog, Tofu...",
        "Find your favorite blogger",
        "‚¨áÔ∏è More Recipe Filters",
        "‚¨ÖÔ∏è Shuffle to mix it up",
        "‚¨ÜÔ∏è Dark Mode: Press & hold logo",
        "üíö your favs for later",
        'Try, "One pot"',
        "Vegan Mac and Cheese üßÄ",
        "or Lasagna üçù",
        "No-bake treats? üç∞",
        "Taco Night? üåÆ",
        "Try a new salad out ü•ó",
        "Or something chocolatey? üç´",
        "OK I'll leave you alone",
        "just kidding. Still here.",
    ];

    let vibeIndex = 0;
    let charIndex = 0;
    let isDeleting = false;
    let typeSpeed = 100;

    // FIX: Clear placeholder immediately when user clicks (focus)
    const sInput = document.getElementById('searchInput');
    if(sInput) {
        sInput.addEventListener('focus', () => {
            sInput.placeholder = '';
        });
    }

    function typeWriter() {
        const input = document.getElementById('searchInput');
        if (!input) return;

        // Stop animating if user is typing or has the box clicked
        if (document.activeElement === input || input.value !== '') {
            setTimeout(typeWriter, 1000); 
            return;
        }

        const currentFullText = vibes[vibeIndex];

        if (isDeleting) {
            input.placeholder = currentFullText.substring(0, charIndex - 1);
            charIndex--;
            typeSpeed = 22; 
        } else {
            input.placeholder = currentFullText.substring(0, charIndex + 1);
            charIndex++;
            typeSpeed = 90; 
        }

        if (!isDeleting && charIndex === currentFullText.length) {
            isDeleting = true;
            typeSpeed = 3000; // Pause at end
        } else if (isDeleting && charIndex === 0) {
            isDeleting = false;
            vibeIndex = (vibeIndex + 1) % vibes.length;
            typeSpeed = 500; 
        }

        setTimeout(typeWriter, typeSpeed);
    }

    typeWriter();
    
    // Filtering State
    let activeType = null; 
    let activeTags = new Set(); 
    let activeCuisines = new Set();
    let isCuisineMenuOpen = false;
    
    const BATCH_SIZE = 48;      

    // --- CONFIGURATION ---
    // Maps internal database names to user-friendly display names
    const BLOG_DISPLAY_MAP = {
        "Rainbow Plant Life GF": "Rainbow Plant Life",
        "Vegan Richa GF": "Vegan Richa"
    };

    // --- KEYWORDS ---
    const SWEET_KEYWORDS = ['cookie', 'cake', 'brownie', 'chocolate', 'dessert', 'pie', 'tart', 'muffin', 'donut', 'doughnut', 'ice cream', 'pudding', 'cheesecake', 'sweet', 'fudge', 'truffle', 'bar', 'cupcake', 'blondie', 'galette', 'cobbler', 'mousse', 'cinnamon roll', 'scone', 'waffle', 'pancake'];
    const MEAL_KEYWORDS = ['pasta', 'burger', 'curry', 'soup', 'stew', 'taco', 'pizza', 'sandwich', 'wrap', 'salad', 'bowl', 'rice', 'noodle', 'stir fry', 'lasagna', 'casserole', 'tofu', 'tempeh', 'lentil', 'chickpea', 'potato', 'dinner', 'lunch', 'roast', 'chili', 'shepherd', 'risotto', 'gnocchi', 'quiche', 'chowder', 'jackfruit', 'cauliflower', 'enchilada', 'burrito', 'quesadilla', 'mac and cheese', 'dumpling', 'meatball', 'loaf', 'skillet', 'gratin', 'pad thai', 'ramen'];
    const PROTEIN_KEYWORDS = ['tofu', 'tempeh', 'seitan', 'tvp', 'lentil', 'bean', 'chickpea', 'edamame', 'soy', 'quinoa', 'peanut', 'meatball', 'burger', 'sausage', 'protein', 'falafel', 'hummus', 'nut roast'];

    const CUISINE_KEYWORDS = {
        "Indian": ['indian', 'curry', 'masala', 'dal', 'tikka', 'saag', 'korma', 'vindaloo', 'naan', 'samosa', 'chutney', 'aloo', 'gobi', 'chana'],
        "Mexican": ['mexican', 'taco', 'burrito', 'enchilada', 'quesadilla', 'salsa', 'guacamole', 'fajita', 'nachos', 'tostada', 'pozole', 'chipotle'],
        "Italian": ['italian', 'tuscan', 'pasta', 'lasagna', 'pizza', 'risotto', 'gnocchi', 'bolognese', 'pesto', 'carbonara', 'marinara', 'focaccia', 'polenta'],
        "Asian": ['asian', 'chinese', 'japanese', 'thai', 'korean', 'vietnamese', 'stir fry', 'noodle', 'ramen', 'pad thai', 'dumpling', 'sushi', 'kimchi', 'miso', 'teriyaki', 'udon', 'bok choy', 'spring roll', 'soy ginger', 'gochujang', 'hoisin'],
        "Middle Eastern": ['middle eastern', 'lebanese', 'hummus', 'falafel', 'tahini', 'shawarma', 'pita', 'couscous', 'tabbouleh', 'shakshuka', "za'atar", 'kabob', 'sumac'],
        "Mediterranean": ['mediterranean', 'greek', 'tzatziki', 'olives', 'feta', 'lemon herb', 'artichoke', 'couscous']
    };

    // --- FAVORITES LOGIC ---
    function loadSavedRecipes() {
        try {
            const raw = localStorage.getItem('saved_recipes');
            if (raw) {
                const arr = JSON.parse(raw);
                // Convert array back to Map
                savedRecipesMap = new Map(arr.map(r => [r.link, r]));
            }
        } catch (e) {
            console.error("Failed to load saved recipes", e);
            savedRecipesMap = new Map();
        }
        updateSavedCount();
    }

    function saveToStorage() {
        try {
            // Store as array of objects to persist metadata
            const arr = Array.from(savedRecipesMap.values());
            localStorage.setItem('saved_recipes', JSON.stringify(arr));
            updateSavedCount();
        } catch (e) {
            console.error("Storage quota exceeded", e);
            alert("Storage full! Could not save recipe.");
        }
    }

    function updateSavedCount() {
        const btn = document.getElementById('savedBtn');
        if (!btn) return;
        
        const count = savedRecipesMap.size;
        btn.innerText = `üíö Saved (${count})`;
        
        // Disable button if count is 0, unless we are currently IN the saved view (to allow exit)
        if (count === 0 && !isSavedView) {
            btn.style.opacity = '0.6';
            btn.style.pointerEvents = 'none';
        } else {
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';
        }
    }

    function toggleSave(e, recipeLink) {
        e.preventDefault();
        e.stopPropagation();

        // 1. Find Recipe Object (Check Main Feed first, then Saved Map)
        let recipe = allRecipes.find(r => r.link === recipeLink);
        if (!recipe) {
            // Fallback: Check if it's already in saved map (e.g. from a previous session but deleted from feed)
            recipe = savedRecipesMap.get(recipeLink);
        }

        if (!recipe) return; 

        const heartBtn = e.currentTarget;
        const card = heartBtn.closest('.card');

        if (savedRecipesMap.has(recipeLink)) {
            // REMOVE
            savedRecipesMap.delete(recipeLink);
            heartBtn.classList.remove('active');
            
            // Visual logic for Saved View: Dim card instead of removing instantly
            if (isSavedView) {
                if (card) card.classList.add('dimmed');
            }
        } else {
            // ADD (Store Metadata for Persistence)
            const savedItem = {
                ...recipe,
                savedAt: Date.now() // Timestamp for sorting
            };
            savedRecipesMap.set(recipeLink, savedItem);
            heartBtn.classList.add('active');
            
            // Visual logic for Saved View: Undim
            if (isSavedView) {
                if (card) card.classList.remove('dimmed');
            }
        }
        
        saveToStorage();
    }

    function toggleSavedView(e) {
        if(e) e.preventDefault();
        const savedBtn = document.getElementById('savedBtn');
        const shareSavedBtn = document.getElementById('shareSavedBtn');
        
        if (isSavedView) {
            // Toggle OFF
            isSavedView = false;
            savedBtn.classList.remove('active-filter');
            shareSavedBtn.style.display = 'none';
        } else {
            // Toggle ON
            if (savedRecipesMap.size === 0) return;
            isSavedView = true;
            savedBtn.classList.add('active-filter');
            shareSavedBtn.style.display = 'flex';
        }
        applyFilters(true);
    }
    
    // --- UTILS ---
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // Standard Levenshtein Distance Algorithm
    function levenshteinDistance(a, b) {
        if (a.length === 0) return b.length;
        if (b.length === 0) return a.length;
        const matrix = [];
        for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
        for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1, 
                        Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1) 
                    );
                }
            }
        }
        return matrix[b.length][a.length];
    }

    // "Tight" Fuzzy Match Logic
    function isFuzzyMatch(query, text) {
        // 1. Fast path: Exact substring match
        if (text.includes(query)) return true;

        // 2. Tokenize: Split user query and target text into words
        const queryTokens = query.split(/\s+/).filter(t => t.length > 0);
        const textTokens = text.split(/\s+/).filter(t => t.length > 0);

        // 3. Logic: Every word in the user's query must "match" a word in the text
        return queryTokens.every(qToken => {
            return textTokens.some(tToken => {
                // Optimization: Skip if length difference is too large
                if (Math.abs(qToken.length - tToken.length) > 2) return false;

                const dist = levenshteinDistance(qToken, tToken);
                
                // TIGHT THRESHOLDS:
                // Word length < 4: Must be exact (e.g., "pie" vs "die")
                // Word length 4-7: Allow 1 typo (e.g., "aple" vs "apple")
                // Word length > 7: Allow 2 typos (e.g., "brocolli" vs "broccoli")
                if (qToken.length < 4) return dist === 0;
                if (qToken.length <= 7) return dist <= 1;
                return dist <= 2;
            });
        });
    }

    // --- INITIALIZATION ---
    // Visitor tracking for Shuffle Animation
    // FIX: Helper to safely access storage (Safari Private Mode throws error)
    loadSavedRecipes();
    function safeGetStorage(key, defaultVal) {
        try {
            return JSON.parse(localStorage.getItem(key) || defaultVal);
        } catch (e) {
            return JSON.parse(defaultVal);
        }
    }
    
    function safeSetStorage(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
        } catch (e) { 
            // Storage quota full or private mode; fail silently
        }
    }

    try {
        const visitKey = 'shuffle_visit_data';
        const now = Date.now();
        const oneHour = 60 * 60 * 1000;
        let visitData = safeGetStorage(visitKey, '{"count": 0, "lastVisit": 0}');
        
        // Reset if more than 1 hour has passed
        if (now - visitData.lastVisit > oneHour) {
            visitData.count = 1; // Start new session
        } else {
            visitData.count++; // Increment within session
        }
        visitData.lastVisit = now;
        safeSetStorage(visitKey, visitData);

        if (visitData.count > 1) {
            const btn = document.getElementById('shuffleIconBtn');
            if (btn) btn.classList.add('jiggle');
        }
    } catch (e) { console.error('Storage logic skipped', e); }

    fetch('data.json?v=' + new Date().getTime())
        .then(response => response.json())
        .then(data => {
            allRecipes = data;
            currentContext = allRecipes; 
            
            setupInfiniteScroll();   
            parseURLState();
        })
        .catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('gallery').innerHTML = '<p style="text-align:center">Could not load recipes.</p>';
            // Remove busy state if error
            document.getElementById('gallery').setAttribute('aria-busy', 'false');
        });

    window.addEventListener('popstate', () => {
        parseURLState();
    });

    // --- DARK MODE LOGIC ---
    let pressTimer;
    let isLongPress = false;
    const logoLink = document.querySelector('.logo-link');

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        // Visual feedback
        if("vibrate" in navigator) navigator.vibrate(50);
        
        // Save preference (optional, but good UX)
        if(document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
        } else {
            localStorage.removeItem('theme');
        }
    }

    // Check saved theme
    if(localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
    }

    function startPress(e) {
        isLongPress = false;
        pressTimer = setTimeout(() => {
            isLongPress = true;
            toggleDarkMode();
        }, 1000); // 1 second
    }

    function cancelPress() {
        clearTimeout(pressTimer);
    }

    // Add listeners to logo
    if(logoLink) {
        logoLink.addEventListener('mousedown', startPress);
        logoLink.addEventListener('touchstart', startPress);
        
        logoLink.addEventListener('mouseup', cancelPress);
        logoLink.addEventListener('mouseleave', cancelPress);
        logoLink.addEventListener('touchend', cancelPress);
        
        // Prevent navigation if it was a long press
        logoLink.addEventListener('click', (e) => {
            if(isLongPress) {
                e.preventDefault();
                isLongPress = false; // reset
            }
        });
    }

    // --- URL & SEO LOGIC ---

    function parseURLState() {
        const params = new URLSearchParams(window.location.search);
        
        activeType = null;
        activeTags.clear();
        isSavedView = false;

        document.getElementById('mealsBtn').classList.remove('active-filter');
        document.getElementById('sweetsBtn').classList.remove('active-filter');
        document.getElementById('savedBtn').classList.remove('active-filter');
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active-filter'));
        document.getElementById('searchInput').value = '';

        if (params.has('q')) {
            document.getElementById('searchInput').value = params.get('q');
            toggleSearchButtons(true);
        } else {
            toggleSearchButtons(false);
        }

        // Handle Saved View URL
        if (params.has('view') && params.get('view') === 'saved') {
            isSavedView = true;
            document.getElementById('savedBtn').classList.add('active-filter');
            document.getElementById('shareSavedBtn').style.display = 'flex';
        } else {
            document.getElementById('shareSavedBtn').style.display = 'none';
        }

        if (params.has('type')) {
            const type = params.get('type');
            activeType = type;
            if (type === 'meal') document.getElementById('mealsBtn').classList.add('active-filter');
            if (type === 'sweet') document.getElementById('sweetsBtn').classList.add('active-filter');
        }

        if (params.has('tag')) {
            const tags = params.get('tag').split(',');
            tags.forEach(t => {
                activeTags.add(t);
                const btn = document.getElementById(t.toLowerCase() + 'Btn');
                if (btn) btn.classList.add('active-filter');
            });
        }

        // Handle Cuisines State via URL
        if (params.has('cuisine')) {
            const cuisines = params.get('cuisine').split(',');
            cuisines.forEach(c => {
                activeCuisines.add(c);
                const chip = document.querySelector(`.cuisine-btn[data-cuisine="${c}"]`);
                if (chip) chip.classList.add('active-filter');
            });
            // If URL loads with cuisine, open the menu directly
            if (activeCuisines.size > 0) {
                isCuisineMenuOpen = true;
                document.getElementById('subControlsWrapper').classList.add('open');
                const arrow = document.querySelector('#cuisinesBtn .dropdown-arrow');
                if (arrow) arrow.classList.add('open');
            }
        }
        updateCuisinesButtonState();

        applyFilters(false); 
    }

    function updateURL() {
        const params = new URLSearchParams();
        const searchVal = document.getElementById('searchInput').value;
        
        if (searchVal) params.set('q', searchVal);
        if (isSavedView) params.set('view', 'saved'); // Add saved to URL
        if (activeType) params.set('type', activeType);
        if (activeTags.size > 0) params.set('tag', Array.from(activeTags).join(','));
        if (activeCuisines.size > 0) params.set('cuisine', Array.from(activeCuisines).join(','));

        const newURL = params.toString() ? `?${params.toString()}` : window.location.pathname;
        
        // FIX: Use replaceState instead of pushState to prevent Android keyboard back-button glitches
        history.replaceState({}, '', newURL);
        
        const canonical = document.getElementById('canonicalLink');
        if (canonical) canonical.href = "https://searchveg.com/" + newURL;
    }

    // 2. DYNAMIC NOINDEX: Helps prevent Soft 404s on empty search results
    function updateNoIndexState(isZeroResults) {
        let meta = document.querySelector('meta[name="robots"]');
        if (isZeroResults) {
            if (!meta) {
                meta = document.createElement('meta');
                meta.name = 'robots';
                document.head.appendChild(meta);
            }
            meta.content = "noindex, follow";
        } else {
            // Restore default if it exists or reset
            if (meta) meta.content = "index, follow, max-image-preview:large";
        }
    }

    function updateSEO(currentRecipes = []) {
        let title = "Daily Vegan Recipes";
        let desc = "Find fresh daily vegan recipes from top bloggers. Search by ingredients, diet types, or explore new plant-based dishes. ";
        let breadcrumbName = "Home";
        
        const searchVal = document.getElementById('searchInput').value;
        const tagsArr = Array.from(activeTags);

        if (isSavedView) {
             title = "My Saved Recipes | Daily Vegan Recipes";
             desc = "Your personalized collection of saved vegan recipes.";
             breadcrumbName = "Saved";
        } else if (searchVal) {
            const safeSearch = searchVal.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            title = `${safeSearch} - Search | Daily Vegan Recipes`;
            desc = `Best vegan recipes matching "${safeSearch}".`;
            breadcrumbName = `Search: ${safeSearch}`;
        } else if (activeType === 'meal') {
            title = "Vegan Dinner & Meal Ideas | Daily Vegan Recipes";
            desc = "Discover savory vegan meals, dinners, and lunch ideas from top plant-based blogs.";
            breadcrumbName = "Meals";
        } else if (activeType === 'sweet') {
            title = "Vegan Sweets & Desserts | Daily Vegan Recipes";
            desc = "Indulge in the best vegan desserts, cookies, cakes, and sweets.";
            breadcrumbName = "Sweets";
        } else if (activeCuisines.size > 0) {
            const cuisinesArr = Array.from(activeCuisines);
            const primaryCuisine = cuisinesArr[0];
            title = `Vegan ${primaryCuisine} Recipes | Daily Vegan Recipes`;
            desc = `Explore the best plant-based and vegan ${primaryCuisine} recipes updated daily.`;
            breadcrumbName = `${primaryCuisine} Cuisine`;
        } else if (tagsArr.length > 0) {
            const primaryTag = tagsArr[0];
            title = `${primaryTag} Vegan Recipes | Daily Vegan Recipes`;
            desc = `Top rated ${primaryTag} vegan recipes updated daily.`;
            breadcrumbName = primaryTag;
        }

        document.title = title;
        const metaDesc = document.getElementById('metaDesc');
        if (metaDesc) metaDesc.content = desc;

        const ogTitle = document.querySelector('meta[property="og:title"]');
        if (ogTitle) ogTitle.content = title;
        
        updateBreadcrumbSchema(breadcrumbName);
        updateItemListSchema(currentRecipes);
        updateNoIndexState(currentRecipes.length === 0);
    }

    function updateBreadcrumbSchema(currentItemName) {
        const oldScript = document.getElementById('dynamic-schema');
        if (oldScript) oldScript.remove();

        if (currentItemName === "Home") return;

        const schema = {
            "@context": "https://schema.org",
            "@type": "BreadcrumbList",
            "itemListElement": [{
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": "https://searchveg.com/"
            }, {
                "@type": "ListItem",
                "position": 2,
                "name": currentItemName,
                "item": window.location.href
            }]
        };

        const script = document.createElement('script');
        script.id = 'dynamic-schema';
        script.type = 'application/ld+json';
        script.text = JSON.stringify(schema);
        document.head.appendChild(script);
    }

    function updateItemListSchema(recipes) {
        const oldScript = document.getElementById('item-list-schema');
        if (oldScript) oldScript.remove();

        if (!recipes || recipes.length === 0) return;

        const topRecipes = recipes.slice(0, 20);

        const schema = {
            "@context": "https://schema.org",
            "@type": "ItemList",
            "itemListElement": topRecipes.map((recipe, index) => ({
                "@type": "ListItem",
                "position": index + 1,
                "url": recipe.link,
                "name": recipe.title,
                "image": recipe.image
            }))
        };

        const script = document.createElement('script');
        script.id = 'item-list-schema';
        script.type = 'application/ld+json';
        script.text = JSON.stringify(schema);
        document.head.appendChild(script);
    }

    // --- RENDER LOGIC ---
    function renderNextBatch() {
        const gallery = document.getElementById('gallery');
        const loader = document.getElementById('loader');
        
        // 7. SEMANTIC OUTLINE: Remove busy state once we start rendering real content
        gallery.setAttribute('aria-busy', 'false');

        if (currentContext.length === 0) {
            gallery.innerHTML = '<div class="no-results">No recipes found. Try a different combination!</div>';
            loader.style.display = 'none';
            return;
        }

        if (renderedCount >= currentContext.length) {
            loader.style.display = 'none';
            return;
        }

        const nextBatch = currentContext.slice(renderedCount, renderedCount + BATCH_SIZE);
        
        nextBatch.forEach((recipe, index) => {
            const isLcpCandidate = (renderedCount === 0 && index < 4);
            const card = createCard(recipe, isLcpCandidate);
            gallery.appendChild(card);
        });

        renderedCount += nextBatch.length;
        
        if (renderedCount < currentContext.length) {
            loader.style.display = 'block';
        } else {
            loader.style.display = 'none';
        }
    }

   function createCard(recipe, isLcp = false) {
        const card = document.createElement('article');
        card.className = 'card';
        
        // Check if Saved
        const isSaved = savedRecipesMap.has(recipe.link);
        
        // If in Saved view and NOT saved (user just clicked heart to remove), add dimmed class
        if (isSavedView && !isSaved) {
            card.className += ' dimmed';
        }

        const link = document.createElement('a');
        link.className = 'card-link';
        link.href = recipe.link;
        link.target = "_blank"; 
        link.rel = "noopener noreferrer";

        const img = document.createElement('img');
        img.src = recipe.image;
        img.width = 400;
        img.height = 250; 
        img.alt = `${recipe.title} - Vegan Recipe by ${recipe.blog_name}`;
        
        img.decoding = "async";
        if (isLcp) {
            img.loading = "eager";
            img.setAttribute("fetchpriority", "high");
        } else {
            img.loading = "lazy"; 
        }
        
        img.referrerPolicy = "no-referrer";
        
        // Broken Image Handler: Fallback to logo.png
        img.onerror = function() { 
            this.onerror = null; 
            this.src = 'logo.png';
            this.style.objectFit = 'contain';
            this.style.padding = '20px';
        };

        const info = document.createElement('div');
        info.className = 'info';

        // NEW TODAY LOGIC: Recalculate based on date vs NOW
        // This ensures old saved recipes don't show "New Today"
        const recipeDate = new Date(recipe.date);
        const now = new Date();
        const hoursOld = (now - recipeDate) / (1000 * 3600);
        
        let badgeHTML = '';
        if (hoursOld < 20) {
            badgeHTML += '<span class="fresh-badge">New Today</span>';
        }

        if (recipe.special_tags && Array.isArray(recipe.special_tags)) {
            recipe.special_tags.forEach(tag => {
                if (tag === 'WFPB') {
                    badgeHTML += '<span class="wfpb-badge">WFPB</span>';
                } else if (tag === 'Easy') {
                    badgeHTML += '<span class="easy-badge">Easy</span>';
                } else if (tag === 'Budget') {
                    badgeHTML += '<span class="budget-badge">Budget</span>';
                } else if (tag === 'GF') {
                    badgeHTML += '<span class="gf-badge">GF</span>';
                }
            });
        }
        
        const displayBlogger = BLOG_DISPLAY_MAP[recipe.blog_name] || recipe.blog_name;

        const safeTitle = recipe.title.replace(/&/g, "&amp;")
                                      .replace(/</g, "&lt;")
                                      .replace(/>/g, "&gt;")
                                      .replace(/"/g, "&quot;")
                                      .replace(/'/g, "&#039;");

        info.innerHTML = `
            <div class="meta-row">
                ${badgeHTML}
            </div>
            <h2 class="title" title="${safeTitle}">${safeTitle}</h2>
            <div class="blogger">by ${displayBlogger}</div>
        `;
        
        // HEART BUTTON
        const heartBtn = document.createElement('button');
        heartBtn.className = `action-btn heart-btn ${isSaved ? 'active' : ''}`;
        heartBtn.ariaLabel = isSaved ? "Unsave Recipe" : "Save Recipe";
        heartBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;
        heartBtn.onclick = (e) => toggleSave(e, recipe.link);

        // SHARE BUTTON
        const shareBtn = document.createElement('button');
        shareBtn.className = 'action-btn share-btn';
        shareBtn.ariaLabel = "Share Recipe";
        shareBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>`;
        shareBtn.onclick = (e) => shareRecipe(e, recipe.title, recipe.link);

        link.appendChild(img);
        link.appendChild(info);
        card.appendChild(heartBtn); // Add Heart
        card.appendChild(shareBtn);
        card.appendChild(link);
        
        return card;
    }

    // Helper: Throttling for scroll performance
    function throttle(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        }
    }

    function setupInfiniteScroll() {
        const handleScroll = throttle(() => {
            const scrollBtn = document.getElementById("scrollTopBtn");
            const scrolled = document.body.scrollTop > 300 || document.documentElement.scrollTop > 300;
            
            if (scrollBtn) scrollBtn.style.display = scrolled ? "flex" : "none";

            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                if (renderedCount < currentContext.length) {
                    renderNextBatch();
                }
            }
        }, 200); // Only run once every 200ms

        window.addEventListener('scroll', handleScroll);
        
        document.getElementById("scrollTopBtn").addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    function resetView(newContext) {
        currentContext = newContext;
        renderedCount = 0;
        // Clears the Skeleton Loaders or previous results
        document.getElementById('gallery').innerHTML = '';
        renderNextBatch();
    }

    function shuffleRecipes() {
        const btn = document.getElementById('shuffleIconBtn');
        if (btn) {
            btn.classList.remove('jiggle');
            void btn.offsetWidth; 
            btn.classList.add('jiggle');
        }

        document.activeElement.blur(); 
        
        // Shuffle the CURRENT context (whether that is All Recipes OR Saved Recipes)
        for (let i = currentContext.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [currentContext[i], currentContext[j]] = [currentContext[j], currentContext[i]];
        }
        
        // Reset render count but keep the data
        renderedCount = 0;
        document.getElementById('gallery').innerHTML = '';
        renderNextBatch();
    }

    function toggleType(e, type) {
        if(e) e.preventDefault(); 
        document.activeElement.blur();
        const mealsBtn = document.getElementById('mealsBtn');
        const sweetsBtn = document.getElementById('sweetsBtn');

        if (activeType === type) {
            activeType = null;
            mealsBtn.classList.remove('active-filter');
            sweetsBtn.classList.remove('active-filter');
        } else {
            activeType = type;
            if (type === 'meal') {
                mealsBtn.classList.add('active-filter');
                sweetsBtn.classList.remove('active-filter');
            } else {
                sweetsBtn.classList.add('active-filter');
                mealsBtn.classList.remove('active-filter');
            }
        }
        applyFilters(true);
    }

    function toggleTag(e, tagName) {
        if(e) e.preventDefault(); 
        document.activeElement.blur();
        const btnId = tagName.toLowerCase() + 'Btn';
        const btn = document.getElementById(btnId);

        if (activeTags.has(tagName)) {
            activeTags.delete(tagName);
            btn.classList.remove('active-filter');
        } else {
            activeTags.add(tagName);
            btn.classList.add('active-filter');
        }
        applyFilters(true);
    }

    function toggleCuisineMenu(e) {
        if(e) e.preventDefault();
        document.activeElement.blur();
        isCuisineMenuOpen = !isCuisineMenuOpen;
        
        const wrapper = document.getElementById('subControlsWrapper');
        const arrow = document.querySelector('#cuisinesBtn .dropdown-arrow');
        
        if (isCuisineMenuOpen) {
            wrapper.classList.add('open');
            arrow.classList.add('open');
        } else {
            wrapper.classList.remove('open');
            arrow.classList.remove('open');
        }
    }

    function toggleCuisine(e, cuisineName) {
        if(e) e.preventDefault();
        document.activeElement.blur();
        
        const btn = document.querySelector(`.cuisine-btn[data-cuisine="${cuisineName}"]`);
        
        if (activeCuisines.has(cuisineName)) {
            activeCuisines.delete(cuisineName);
            btn.classList.remove('active-filter');
        } else {
            activeCuisines.add(cuisineName);
            btn.classList.add('active-filter');
        }
        
        updateCuisinesButtonState();
        applyFilters(true);
    }

    // Colors main button green if ANY cuisine is selected 
    function updateCuisinesButtonState() {
        const cuisinesBtn = document.getElementById('cuisinesBtn');
        if (!cuisinesBtn) return;
        if (activeCuisines.size > 0) {
            cuisinesBtn.classList.add('active-filter');
        } else {
            cuisinesBtn.classList.remove('active-filter');
        }
    }

    function applyFilters(pushState = true) {
        const rawInput = document.getElementById('searchInput').value;
        const term = rawInput.toLowerCase().replace(/-/g, ' '); 
        
        const SAVORY_EXCEPTIONS = ['sweet potato', 'sweet and sour', 'sweet corn', 'sweet pea', 'sweet chili', 'sweet pepper'];
        const SWEET_EXCEPTIONS = ['rice', 'instant pot', 'crock pot', 'one pot', 'cup', 'butter', 'nut']; 

        // 1. Determine Source (Main Feed or Saved Recipes)
        let filtered = [];
        
        if (isSavedView) {
            // Source: localStorage Map (Sorted by Date Saved DESC)
            filtered = Array.from(savedRecipesMap.values());
            filtered.sort((a, b) => (b.savedAt || 0) - (a.savedAt || 0));
        } else {
            // Source: Main Feed
            filtered = allRecipes;
        }

        // 2. Apply Search
        if (term.length > 0) {
            filtered = filtered.filter(recipe => {
                if (term === 'protein') {
                    const t = recipe.title.toLowerCase();
                    return PROTEIN_KEYWORDS.some(k => t.includes(k));
                }
                
                // Fuzzy Match on Title, Blog Name, and Tags
                const title = recipe.title.toLowerCase().replace(/-/g, ' ');
                const blogger = recipe.blog_name.toLowerCase().replace(/-/g, ' ');
                const tags = (recipe.special_tags || []).join(' ').toLowerCase().replace(/-/g, ' ');
                const searchableText = `${title} ${blogger} ${tags}`;
                
                return isFuzzyMatch(term, searchableText);
            });
        }

        // 3. Apply Categories (Meal vs Sweet)
        if (activeType === 'meal') {
            filtered = filtered.filter(recipe => {
                const t = recipe.title.toLowerCase();
                const hasMealKeyword = MEAL_KEYWORDS.some(k => t.includes(k));
                const hasSweetKeyword = SWEET_KEYWORDS.some(k => t.includes(k));
                const isSavoryException = SAVORY_EXCEPTIONS.some(k => t.includes(k));
                const isSide = t.includes('sauce') || t.includes('dressing') || t.includes('side') || t.includes('treats');
                return hasMealKeyword && (!hasSweetKeyword || isSavoryException) && !isSide;
            });
        } else if (activeType === 'sweet') {
            filtered = filtered.filter(recipe => {
                const t = recipe.title.toLowerCase();
                const hasSweetKeyword = SWEET_KEYWORDS.some(k => t.includes(k));
                const hasMealKeyword = MEAL_KEYWORDS.some(k => t.includes(k));
                const isSweetException = SWEET_EXCEPTIONS.some(k => t.includes(k));
                const isSavory = t.includes('spicy') || t.includes('chili') || t.includes("shepherd's") || t.includes('egg') || t.includes('burger');
                const isExplicitlySavory = SAVORY_EXCEPTIONS.some(k => t.includes(k));
                return hasSweetKeyword && (!hasMealKeyword || isSweetException) && !isExplicitlySavory && !isSavory;
            });
        }

       // 4. Apply Tags
       if (activeTags.size > 0) {
            filtered = filtered.filter(recipe => {
                const title = recipe.title.toLowerCase();
                
                for (let tag of activeTags) {
                    if (tag === 'Protein') {
                        if (!PROTEIN_KEYWORDS.some(k => title.includes(k))) return false;
                    } 
                    else {
                        if (!recipe.special_tags || !recipe.special_tags.includes(tag)) return false;
                    }
                }
                return true;
            });
        }

        // 5. Apply Cuisines (OR logic within cuisines, AND logic with other filters)
        if (activeCuisines.size > 0) {
            let activeKeywords = [];
            activeCuisines.forEach(c => {
                if (CUISINE_KEYWORDS[c]) {
                    activeKeywords.push(...CUISINE_KEYWORDS[c]);
                }
            });
            
            filtered = filtered.filter(recipe => {
                const title = recipe.title.toLowerCase();
                // Check if any of the active cuisine keywords exist in the title
                return activeKeywords.some(k => title.includes(k.toLowerCase()));
            });
        }

        if (pushState) {
            updateURL();
        }
        
        updateSEO(filtered);
        resetView(filtered);
    }

    const processSearchChange = debounce(() => {
        applyFilters(true);
    }, 300);

    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');
    const shareSearchBtn = document.getElementById('shareSearchBtn');

    function toggleSearchButtons(hasText) {
        if (hasText) {
            clearBtn.style.display = 'block';
            shareSearchBtn.style.display = 'block';
        } else {
            clearBtn.style.display = 'none';
            shareSearchBtn.style.display = 'none';
        }
    }

    searchInput.addEventListener('keyup', (e) => {
        const hasText = searchInput.value.length > 0;
        toggleSearchButtons(hasText);
        
        // UX: Enter key dismisses keyboard/blurs input
        if (e.key === 'Enter') {
            searchInput.blur();
        }
        processSearchChange();
    });

   clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        searchInput.focus();
        toggleSearchButtons(false);
        applyFilters(true);
    });
    
    // Share current Search URL
    shareSearchBtn.addEventListener('click', () => {
        const url = window.location.href;
        if (navigator.share) {
            navigator.share({
                title: 'Daily Vegan Recipes Search',
                url: url
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(url).then(() => {
                alert("Search URL copied to clipboard!");
            });
        }
    });

    // --- PWA INSTALL LOGIC ---
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
        // 1. Prevent Chrome 67 and earlier from automatically showing the prompt
        e.preventDefault();
        // 2. Stash the event so it can be triggered later.
        deferredPrompt = e;
        
        // 3. check visit count (User must have visited more than 1 time)
        try {
            const visitData = JSON.parse(localStorage.getItem('shuffle_visit_data') || '{"count": 0}');
            if (visitData.count > 1) {
                installBtn.style.display = 'flex';
            }
        } catch (err) {
            console.log('Storage access error', err);
        }
    });

    async function installPWA() {
        if (!deferredPrompt) return;
        
        // Hide the button immediately
        installBtn.style.display = 'none';
        
        // Show the install prompt
        deferredPrompt.prompt();
        
        // Wait for the user to respond to the prompt
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`User response to install prompt: ${outcome}`);
        
        // We've used the prompt, and can't use it again, throw it away
        deferredPrompt = null;
    }

    window.addEventListener('appinstalled', () => {
        // Hide the app-provided install promotion
        installBtn.style.display = 'none';
        deferredPrompt = null;
        console.log('PWA was installed');
    });

    function shareSavedList() {
        if (savedRecipesMap.size === 0) {
            alert("No saved recipes to share!");
            return;
        }

        let text = "My Saved Recipes from searchveg.com:\n\n";
        // Convert Map to array and reverse to show most recent first (matching the view)
        const recipes = Array.from(savedRecipesMap.values()).sort((a, b) => (b.savedAt || 0) - (a.savedAt || 0));
        
        recipes.forEach(r => {
            text += `${r.title} - ${r.link}\n`;
        });

        if (navigator.share) {
            navigator.share({
                title: 'My Saved Vegan Recipes',
                text: text
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(text).then(() => {
                alert("Saved recipes copied to clipboard!");
            });
        }
    }

    function shareRecipe(e, title, link) {
        e.preventDefault(); 
        e.stopPropagation(); 
        if (navigator.share) {
            navigator.share({ title: title, url: link }).catch(console.error);
        } else {
            navigator.clipboard.writeText(link);
            alert("Link copied to clipboard!");
        }
    }
</script>

</body>
</html>
